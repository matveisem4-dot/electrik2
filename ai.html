<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEURO MONOLITH - LOCAL CORE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { background: #050505; color: #e5e7eb; font-family: 'Inter', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .chat-container { flex: 1; overflow-y: auto; padding: 1.5rem; scrollbar-width: none; }
        .chat-container::-webkit-scrollbar { display: none; }
        .message { margin-bottom: 1.5rem; animation: fadeInUp 0.3s ease; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .input-bar { background: #0a0a0a; border-top: 1px solid #1a1a1a; padding: 1rem 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
        #progress-bar { position: fixed; top: 0; left: 0; height: 2px; background: #6366f1; transition: width 0.3s; z-index: 1000; }
        .pass-overlay { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="progress-bar" style="width: 0%"></div>

    <div id="lock" class="pass-overlay">
        <div class="mb-6 w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-2xl shadow-indigo-500/20">
            <i class="fas fa-brain text-white text-3xl"></i>
        </div>
        <input type="password" id="pInput" class="bg-zinc-900 border border-zinc-800 rounded-xl p-3 text-center outline-none focus:border-indigo-500 transition mb-4" placeholder="Введите код">
        <button onclick="checkPass()" class="text-xs font-bold text-zinc-500 hover:text-white uppercase tracking-widest">Активация системы</button>
    </div>

    <header class="p-4 border-b border-white/5 bg-black/50 backdrop-blur-xl flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center shadow-lg"><i class="fas fa-brain text-xs"></i></div>
            <span class="font-black text-xs tracking-widest uppercase">Neuro Engine X</span>
        </div>
        <div id="engine-status" class="text-[9px] font-bold text-yellow-500 uppercase px-3 py-1 bg-yellow-500/10 rounded-full">Ядро: Ожидание...</div>
    </header>

    <div id="chat" class="chat-container">
        <div class="bg-indigo-600/10 border border-indigo-600/20 p-4 rounded-2xl text-xs text-indigo-300 mb-6">
            <i class="fas fa-info-circle mr-2"></i> Система «Монолит» запущена локально. API не используется. <br>
            Вся нагрузка ложится на ваше устройство. Хостинг GitHub Pages только хранит интерфейс.
        </div>
    </div>

    <div class="input-bar">
        <input type="text" id="userInput" placeholder="Сначала загрузите мозги..." class="flex-1 bg-transparent outline-none text-sm" disabled>
        <button id="sendBtn" onclick="sendMessage()" class="w-10 h-10 bg-indigo-600 rounded-xl opacity-20 transition" disabled>
            <i class="fas fa-arrow-up"></i>
        </button>
    </div>

    <script type="module">
        import * as webllm from "https://esm.run/@mlc-ai/web-llm";

        const chat = document.getElementById('chat');
        const input = document.getElementById('userInput');
        const btn = document.getElementById('sendBtn');
        const status = document.getElementById('engine-status');
        const progress = document.getElementById('progress-bar');

        // Модель (мозги): используем маленькую Llama-3 для скорости
        const model = "Llama-3-8B-Instruct-q4f16_1-MLC"; 
        const engine = new webllm.MLCEngine();

        window.checkPass = async () => {
            if(document.getElementById('pInput').value === "1234") {
                document.getElementById('lock').style.display = 'none';
                initEngine();
            } else { alert("Неверный код"); }
        }

        async function initEngine() {
            engine.setInitProgressCallback((report) => {
                progress.style.width = (report.progress * 100) + "%";
                status.innerText = `Загрузка: ${Math.round(report.progress * 100)}%`;
                if(report.progress === 1) {
                    status.innerText = "Система Онлайн";
                    status.className = "text-[9px] font-bold text-green-500 uppercase px-3 py-1 bg-green-500/10 rounded-full";
                    input.disabled = false;
                    input.placeholder = "Напишите запрос...";
                    btn.disabled = false;
                    btn.classList.remove('opacity-20');
                }
            });
            await engine.reload(model);
        }

        window.sendMessage = async () => {
            const val = input.value.trim();
            if(!val) return;

            addMsg(val, 'user');
            input.value = "";
            const aiDiv = addMsg("Обработка нейронами...", 'ai');
            
            let fullReply = "";
            const chunks = await engine.chat.completions.create({
                messages: [{ role: "user", content: val }],
                stream: true,
            });

            for await (const chunk of chunks) {
                fullReply += chunk.choices[0]?.delta?.content || "";
                aiDiv.innerText = fullReply;
                chat.scrollTop = chat.scrollHeight;
            }
        }

        function addMsg(text, role) {
            const d = document.createElement('div');
            d.className = `message flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            d.innerHTML = `<div class="max-w-[85%] p-4 rounded-2xl text-sm ${role === 'user' ? 'bg-indigo-600' : 'bg-zinc-900 border border-white/5'}">${text}</div>`;
            chat.appendChild(d);
            chat.scrollTop = chat.scrollHeight;
            return d.querySelector('div');
        }
    </script>
</body>
</html>
