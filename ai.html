<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberMind AI</title>
    <style>
        :root { --accent: #00d2ff; }
        body { background: #0b0e14; color: #fff; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; }
        #chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 12px; border-radius: 15px; max-width: 85%; line-height: 1.4; }
        .user { align-self: flex-end; background: var(--accent); color: #000; font-weight: 500; }
        .ai { align-self: flex-start; background: #1a1f29; border: 1px solid #2d3748; }
        .input-area { padding: 15px; background: #161b22; display: flex; gap: 10px; border-top: 1px solid #2d3748; }
        input { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #30363d; background: #0d1117; color: #fff; outline: none; }
        button { background: var(--accent); border: none; padding: 0 20px; border-radius: 10px; cursor: pointer; font-weight: bold; }
        #status { font-size: 11px; color: #8b949e; padding: 5px 20px; background: #0d1117; }
        .loading-bar { height: 2px; background: var(--accent); width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>

<div id="status">Проверка совместимости...</div>
<div id="progress-line" class="loading-bar"></div>
<div id="chat">
    <div class="msg ai">Привет! Я CyberMind. Я загружаюсь прямо в твой браузер. Подожди немного, и я смогу общаться даже без интернета.</div>
</div>

<div class="input-area">
    <input type="text" id="user-input" placeholder="Напиши мне что-нибудь...">
    <button id="send-btn">ОК</button>
</div>

<script type="module">
    // Используем стабильную версию библиотеки
    import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1';

    // Настройки: отключаем принудительный GPU, чтобы не пугать браузер
    env.allowLocalModels = false;
    
    let generator;
    const status = document.getElementById('status');
    const progressLine = document.getElementById('progress-line');
    const chat = document.getElementById('chat');
    const input = document.getElementById('user-input');

    async function init() {
        try {
            status.innerText = "Установка связи с нейросетью (WASM)...";
            
            // Загружаем очень легкую модель (около 130 Мб)
            // Она работает везде, где есть хотя бы 2 ГБ оперативки
            generator = await pipeline('text-generation', 'Xenova/tiny-random-Gpt2', {
                progress_callback: (p) => {
                    if (p.status === 'progress') {
                        progressLine.style.width = p.progress + '%';
                        status.innerText = `Загрузка интеллекта: ${Math.round(p.progress)}%`;
                    }
                }
            });

            status.innerText = "CyberMind готов к работе локально.";
            progressLine.style.display = 'none';
        } catch (e) {
            console.error(e);
            status.innerText = "Ошибка. Попробуй обновить страницу.";
        }
    }

    async function send() {
        const text = input.value.trim();
        if (!text || !generator) return;

        addMsg(text, 'user');
        input.value = '';
        status.innerText = "CyberMind размышляет...";

        try {
            const output = await generator(text, { 
                max_new_tokens: 40,
                temperature: 0.7,
                do_sample: true
            });

            let response = output[0].generated_text.replace(text, '').trim();
            if (!response) response = "... (задумался)";
            
            addMsg(response, 'ai');
        } catch (err) {
            addMsg("Произошел сбой в мыслительном процессе.", 'ai');
        }
        
        status.innerText = "Готов.";
    }

    function addMsg(txt, side) {
        const d = document.createElement('div');
        d.className = `msg ${side}`;
        d.innerText = txt;
        chat.appendChild(d);
        chat.scrollTop = chat.scrollHeight;
    }

    document.getElementById('send-btn').onclick = send;
    input.onkeydown = (e) => { if(e.key === 'Enter') send(); };
    
    init();
</script>
</body>
</html>
