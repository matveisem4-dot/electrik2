<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FearConnect P2P Pro</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #0b141a; --side: #111b21; --panel: #202c33; --accent: #ff4444; --text: #e9edef; --msg-out: #005c4b; }
        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }

        /* –í—Ö–æ–¥ */
        #login-screen { position: fixed; inset: 0; background: var(--bg); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-box { background: var(--panel); padding: 30px; border-radius: 20px; text-align: center; width: 100%; max-width: 350px; }

        /* –°–µ—Ç–∫–∞ */
        .app-container { display: flex; height: 100vh; width: 100vw; position: relative; }
        .sidebar { width: 350px; background: var(--side); border-right: 1px solid #333; display: flex; flex-direction: column; transition: 0.3s; z-index: 10; }
        .chat-window { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; transition: 0.3s; z-index: 5; }

        @media (max-width: 768px) {
            .sidebar { position: absolute; width: 100%; height: 100%; }
            .sidebar.hidden { transform: translateX(-100%); }
            .chat-window { position: absolute; width: 100%; height: 100%; left: 0; }
            .chat-window.active { z-index: 20; }
        }

        .header { padding: 10px 15px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; min-height: 60px; }
        
        /* –í–∏–¥–µ–æ (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ) */
        .video-overlay { position: absolute; top: 70px; right: 10px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
        video { width: 120px; border-radius: 12px; background: #000; border: 2px solid var(--accent); }
        #remoteV { width: 220px; display: none; border-color: #00a884; }

        #messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 10px 14px; border-radius: 12px; max-width: 85%; font-size: 15px; }
        .msg.in { background: var(--panel); align-self: flex-start; }
        .msg.out { background: var(--msg-out); align-self: flex-end; }

        .input-area { padding: 10px; background: var(--panel); display: flex; gap: 10px; }
        input { background: #2a3942; border: none; padding: 12px; color: #fff; border-radius: 10px; flex: 1; outline: none; }
        button { background: var(--accent); border: none; padding: 10px 15px; color: #fff; border-radius: 10px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>FearConnect</h2>
            <input type="text" id="my-id-inp" placeholder="–¢–≤–æ–π –Ω–∏–∫">
            <button onclick="login()">–í–û–ô–¢–ò</button>
        </div>
    </div>

    <div class="app-container">
        <div class="sidebar" id="sidebar">
            <div class="header"><b id="user-view"></b><span>‚öôÔ∏è</span></div>
            <div style="padding: 10px; border-bottom: 1px solid #333;">
                <input type="text" id="f-id" placeholder="ID –¥—Ä—É–≥–∞">
                <input type="text" id="f-name" placeholder="–ò–º—è –¥—Ä—É–≥–∞">
                <button onclick="addChat()" style="width:100%">+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</button>
            </div>
            <div id="chat-list" style="overflow-y:auto; flex:1"></div>
        </div>

        <div class="chat-window" id="chat-window">
            <div class="header">
                <button onclick="back()" style="background:none; border:none; color:#fff; font-size:20px">‚¨Ö</button>
                <b id="chat-title">–ß–∞—Ç</b>
                <button onclick="startCall()" style="background:#28a745">üìû –ó–≤–æ–Ω–æ–∫</button>
            </div>
            <div class="video-overlay">
                <video id="localV" autoplay muted playsinline></video>
                <video id="remoteV" autoplay playsinline></video>
            </div>
            <div id="messages"></div>
            <div class="input-area">
                <input type="text" id="msg-inp" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                <button onclick="sendMsg()">‚û§</button>
            </div>
        </div>
    </div>

    <script>
        let peer, conn, localStream, currentTargetId;
        let chats = JSON.parse(localStorage.getItem('f_chats') || '{}');

        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã –°–†–ê–ó–£
        async function initMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                document.getElementById('localV').srcObject = localStream;
                console.log("–ö–∞–º–µ—Ä–∞ –≥–æ—Ç–æ–≤–∞");
            } catch(e) {
                alert("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã! –ü—Ä–æ–≤–µ—Ä—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ.");
            }
        }

        function login() {
            const id = document.getElementById('my-id-inp').value;
            if(!id) return;
            peer = new Peer(id);
            
            peer.on('open', () => {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('user-view').innerText = id;
                initMedia(); // –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞
                renderChats();
            });

            // –°–ª—É—à–∞–µ–º –í–•–û–î–Ø–©–ò–ï –ó–í–û–ù–ö–ò
            peer.on('call', call => {
                if(confirm("–í–∞–º –∑–≤–æ–Ω–∏—Ç " + (chats[call.peer] || call.peer))) {
                    call.answer(localStream); // –û—Ç–≤–µ—á–∞–µ–º –°–í–û–ò–ú –ø–æ—Ç–æ–∫–æ–º
                    handleStream(call);
                }
            });

            peer.on('connection', c => {
                conn = c;
                currentTargetId = c.peer;
                setupConn();
                openChatUI();
            });
        }

        function handleStream(call) {
            call.on('stream', remoteStream => {
                console.log("–ü–æ–ª—É—á–µ–Ω –ø–æ—Ç–æ–∫ –æ—Ç –¥—Ä—É–≥–∞!");
                const rv = document.getElementById('remoteV');
                rv.srcObject = remoteStream;
                rv.style.display = 'block';
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –¥–ª—è –º–æ–±–∏–ª–æ–∫
                rv.play().catch(e => console.log("–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω"));
            });
        }

        function startCall() {
            if(!currentTargetId) return alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç!");
            console.log("–ó–≤–æ–Ω–∏–º: " + currentTargetId);
            const call = peer.call(currentTargetId, localStream); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –°–í–û–ô –ø–æ—Ç–æ–∫
            handleStream(call); // –°–ª—É—à–∞–µ–º –ß–£–ñ–û–ô –ø–æ—Ç–æ–∫
        }

        // –û—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ —á–∞—Ç–∞
        function addChat() {
            const id = document.getElementById('f-id').value;
            const name = document.getElementById('f-name').value;
            if(id && name) { 
                chats[id] = name; 
                localStorage.setItem('f_chats', JSON.stringify(chats)); 
                renderChats(); 
            }
        }

        function renderChats() {
            const list = document.getElementById('chat-list');
            list.innerHTML = '';
            for(let id in chats) {
                let d = document.createElement('div');
                d.style.padding = '15px'; d.style.borderBottom = '1px solid #222';
                d.innerHTML = `<b>${chats[id]}</b><br><small>${id}</small>`;
                d.onclick = () => selectChat(id);
                list.appendChild(d);
            }
        }

        function selectChat(id) {
            currentTargetId = id;
            document.getElementById('chat-title').innerText = chats[id];
            document.getElementById('messages').innerHTML = localStorage.getItem('h_'+id) || '';
            openChatUI();
            conn = peer.connect(id);
            setupConn();
        }

        function setupConn() {
            conn.on('data', d => addMsg(chats[conn.peer] || conn.peer, d, 'in'));
        }

        function sendMsg() {
            const i = document.getElementById('msg-inp');
            if(i.value && conn && conn.open) {
                conn.send(i.value);
                addMsg('–Ø', i.value, 'out');
                i.value = '';
            }
        }

        function addMsg(u, t, type) {
            let m = document.createElement('div');
            m.className = `msg ${type}`;
            m.innerHTML = `<small style="opacity:0.6;font-size:10px">${u}</small><br>${t}`;
            document.getElementById('messages').appendChild(m);
            document.getElementById('messages').scrollTop = 99999;
            localStorage.setItem('h_'+currentTargetId, document.getElementById('messages').innerHTML);
        }

        function openChatUI() {
            if(window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.add('hidden');
                document.getElementById('chat-window').classList.add('active');
            }
        }

        function back() {
            document.getElementById('sidebar').classList.remove('hidden');
            document.getElementById('chat-window').classList.remove('active');
        }
    </script>
</body>
</html>
