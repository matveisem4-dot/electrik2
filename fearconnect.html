<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FearConnect Fix</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #000; --accent: #ff3b30; --panel: #111; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body { font-family: sans-serif; background: var(--bg); color: #fff; height: 100vh; overflow: hidden; }
        
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; }
        .active { display: flex; }
        
        input { background: #1a1a1a; border: 1px solid #333; padding: 15px; color: #fff; border-radius: 12px; width: 100%; margin-bottom: 10px; font-size: 16px; }
        .btn { padding: 15px; background: var(--accent); border: none; color: #fff; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; }

        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 80%; word-wrap: break-word; }
        .msg.out { background: var(--accent); align-self: flex-end; }
        .msg.in { background: #333; align-self: flex-start; }

        #call-ui { position: fixed; inset: 0; background: #000; z-index: 9999; display: none; flex-direction: column; }
        video { width: 100%; height: 50%; object-fit: cover; background: #111; }
        .controls { padding: 20px; display: flex; justify-content: center; background: #000; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen active" style="justify-content:center; padding:40px;">
        <h1 style="color:var(--accent); text-align:center; margin-bottom:20px;">FearConnect</h1>
        <input type="text" id="my-id" placeholder="–í–∞—à ID">
        <input type="password" id="my-pass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn" onclick="connect()">–í–û–ô–¢–ò</button>
    </div>

    <div id="list-screen" class="screen">
        <div style="padding:40px 20px 10px; background:#111;"><h2>–ß–∞—Ç—ã</h2></div>
        <div id="chat-list" style="flex:1; overflow-y:auto;"></div>
        <div style="padding:20px; display:flex; gap:10px;">
            <input type="text" id="f-id" placeholder="ID –¥—Ä—É–≥–∞" style="margin:0;">
            <button class="btn" style="width:60px;" onclick="addFriend()">+</button>
        </div>
    </div>

    <div id="chat-screen" class="screen">
        <div style="padding:40px 20px 10px; background:#111; display:flex; justify-content:space-between;">
            <button onclick="switchScreen('list-screen')" style="background:none; border:none; color:var(--accent);">‚¨Ö –ù–∞–∑–∞–¥</button>
            <b id="chat-title">...</b>
            <button onclick="startCall()" style="background:none; border:none; font-size:20px;">üìû</button>
        </div>
        <div id="messages"></div>
        <div style="padding:15px; display:flex; gap:10px; background:#111;">
            <input type="text" id="msg-input" style="margin:0;" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
            <button onclick="send()" class="btn" style="width:60px;">‚û§</button>
        </div>
    </div>

    <div id="call-ui">
        <video id="v-remote" autoplay playsinline></video>
        <video id="v-local" autoplay muted playsinline style="height:30%; border-top: 2px solid var(--accent);"></video>
        <div class="controls">
            <button class="btn" style="width:150px; border-radius:30px;" onclick="hangup()">–ó–ê–í–ï–†–®–ò–¢–¨</button>
        </div>
    </div>

<script>
    let peer, conn, myStream, targetId;
    let chats = JSON.parse(localStorage.getItem('fc_chats') || '{}');

    // 1. –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï
    function connect() {
        const id = document.getElementById('my-id').value;
        const pass = document.getElementById('my-pass').value;
        if(!id || !pass) return alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ!");

        // –ü—Ä—è—á–µ–º —Å—Ç–∞—Ä—ã–µ —Å–µ—Å—Å–∏–∏
        if(peer) peer.destroy();

        peer = new Peer(id, {
            config: {'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }]},
            debug: 1
        });

        peer.on('open', () => {
            switchScreen('list-screen');
            renderList();
            // –°—Ä–∞–∑—É –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –Ω–µ —Ç—É–ø–∏–ª–æ
            navigator.mediaDevices.getUserMedia({video:true, audio:true})
                .then(s => { myStream = s; document.getElementById('v-local').srcObject = s; })
                .catch(e => alert("–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞!"));
        });

        peer.on('connection', c => {
            conn = c;
            setupConn();
        });

        peer.on('call', call => {
            if(confirm("–ó–≤–æ–Ω–æ–∫! –û—Ç–≤–µ—Ç–∏—Ç—å?")) {
                call.answer(myStream);
                showCall(true);
                call.on('stream', s => document.getElementById('v-remote').srcObject = s);
            }
        });
    }

    // 2. –†–ê–ë–û–¢–ê –° –°–û–û–ë–©–ï–ù–ò–Ø–ú–ò
    function setupConn() {
        conn.on('data', data => {
            if(data === 'END_CALL') showCall(false);
            else showMsg(conn.peer, data, 'in');
        });
    }

    function send() {
        const i = document.getElementById('msg-input');
        if(!i.value) return;

        // –ï—Å–ª–∏ —Å–≤—è–∑–∏ –Ω–µ—Ç ‚Äî –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è "–Ω–∞ –ª–µ—Ç—É"
        if(!conn || !conn.open) {
            conn = peer.connect(targetId);
            conn.on('open', () => {
                conn.send(i.value);
                showMsg('–í—ã', i.value, 'out');
                i.value = '';
            });
        } else {
            conn.send(i.value);
            showMsg('–í—ã', i.value, 'out');
            i.value = '';
        }
    }

    // 3. –ó–í–û–ù–ö–ò
    function startCall() {
        showCall(true);
        const call = peer.call(targetId, myStream);
        call.on('stream', s => document.getElementById('v-remote').srcObject = s);
    }

    function hangup() {
        if(conn) conn.send('END_CALL');
        showCall(false);
        location.reload(); // –ñ–µ—Å—Ç–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏
    }

    // 4. –ò–ù–¢–ï–†–§–ï–ô–°
    function showMsg(u, t, type) {
        const m = document.createElement('div');
        m.className = 'msg ' + type;
        m.innerText = t;
        document.getElementById('messages').appendChild(m);
        const box = document.getElementById('messages');
        box.scrollTop = box.scrollHeight;
    }

    function renderList() {
        const l = document.getElementById('chat-list'); l.innerHTML = '';
        for(let id in chats) {
            const d = document.createElement('div');
            d.style.padding = '20px'; d.style.borderBottom = '1px solid #222';
            d.innerHTML = `<b>${chats[id]}</b><br><small>ID: ${id}</small>`;
            d.onclick = () => {
                targetId = id;
                document.getElementById('chat-title').innerText = chats[id];
                document.getElementById('messages').innerHTML = '';
                switchScreen('chat-screen');
                conn = peer.connect(id);
                conn.on('open', setupConn);
            };
            l.appendChild(d);
        }
    }

    function addFriend() {
        const id = document.getElementById('f-id').value;
        if(id) {
            chats[id] = "–î—Ä—É–≥ " + id;
            localStorage.setItem('fc_chats', JSON.stringify(chats));
            renderList();
        }
    }

    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function showCall(v) { document.getElementById('call-ui').style.display = v ? 'flex' : 'none'; }
</script>
</body>
</html>
