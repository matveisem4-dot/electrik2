<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FearConnect Fix</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #0b141a; color: white; font-family: sans-serif; margin: 0; display: flex; align-items: center; justify-content: center; height: 100vh; }
        .box { background: #202c33; padding: 25px; border-radius: 20px; width: 85%; max-width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: none; background: #2a3942; color: white; }
        button { width: 100%; padding: 15px; border-radius: 10px; border: none; background: #ff4444; color: white; font-weight: bold; cursor: pointer; }
        #status-log { font-size: 11px; color: #ffaa00; margin-bottom: 10px; min-height: 14px; }
        .screen { display: none; flex-direction: column; width: 100%; height: 100%; position: absolute; top: 0; left: 0; background: #0b141a; }
        .screen.active { display: flex; }
        .header { background: #202c33; padding: 15px; font-weight: bold; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

    <div id="login-screen" class="box">
        <h2 style="color:#ff4444; margin:0 0 10px 0;">FearConnect</h2>
        <div id="status-log">Ожидание ввода...</div>
        <input type="text" id="my-id" placeholder="Любой ник (английскими)">
        <input type="password" id="my-pass" placeholder="Любой пароль">
        <button onclick="initApp()">ВОЙТИ</button>
        <p style="font-size: 10px; opacity: 0.5; margin-top: 15px;">Если не заходит, попробуй выключить/включить интернет или сменить браузер.</p>
    </div>

    <div id="list-screen" class="screen">
        <div class="header"><span>Чаты</span><span id="id-tag"></span></div>
        <div id="chat-list" style="padding: 10px;"></div>
        <div style="padding: 20px;">
            <input type="text" id="f-id" placeholder="ID друга">
            <button onclick="addFriend()">Добавить друга</button>
        </div>
    </div>

<script>
    let peer;
    const log = (msg) => document.getElementById('status-log').innerText = msg;

    function initApp() {
        const id = document.getElementById('my-id').value.trim();
        const pass = document.getElementById('my-pass').value.trim();

        if(!id) {
            log("Ошибка: Введите ник!");
            return;
        }

        log("Подключение к серверу...");

        // Создаем Peer с более надежными настройками
        peer = new Peer(id, {
            host: '0.peerjs.com', // Явно указываем сервер
            port: 443,
            secure: true,
            pingInterval: 5000,
            config: {
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            }
        });

        peer.on('open', (id) => {
            log("Успех!");
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('list-screen').classList.add('active');
            document.getElementById('id-tag').innerText = id;
            localStorage.setItem('last_id', id);
        });

        peer.on('error', (err) => {
            console.error(err.type);
            if(err.type === 'unavailable-id') {
                log("ID '" + id + "' занят. Попробуй другой!");
            } else if(err.type === 'network') {
                log("Ошибка сети! Проверь интернет.");
            } else if(err.type === 'browser-incompatible') {
                log("Браузер не поддерживает связь.");
            } else {
                log("Ошибка: " + err.type);
            }
            // Если ошибка, пробуем убить старый коннект через 2 сек
            setTimeout(() => peer.destroy(), 2000);
        });
    }

    function addFriend() {
        const fid = document.getElementById('f-id').value;
        if(fid) {
            const item = document.createElement('div');
            item.style.padding = "15px";
            item.style.borderBottom = "1px solid #333";
            item.innerText = "Чат с " + fid;
            document.getElementById('chat-list').appendChild(item);
        }
    }
</script>
</body>
</html>
