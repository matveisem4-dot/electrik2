<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>FearConnect Pro</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #0b141a; --panel: #202c33; --accent: #ff4444; --text: #e9edef; --msg-out: #005c4b; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body, html { 
            margin: 0; padding: 0; height: 100%; 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg); color: var(--text); 
            overflow: hidden; position: fixed; width: 100%;
        }

        /* –£–±–∏—Ä–∞–µ–º "–±—Ä–∞—É–∑–µ—Ä–Ω–æ—Å—Ç—å" */
        .screen { 
            position: absolute; inset: 0; 
            padding-top: env(safe-area-inset-top); 
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            background: var(--bg); visibility: hidden; display: flex; flex-direction: column; 
        }
        .screen.active { visibility: visible; transform: translateX(0); }
        .screen.hidden-left { transform: translateX(-100%); }
        .screen.hidden-right { transform: translateX(100%); }

        /* –ö—Ä–∞—Å–∏–≤—ã–π –≤—Ö–æ–¥ */
        #login-screen { z-index: 1000; visibility: visible; display: flex; align-items: center; justify-content: center; background: linear-gradient(180deg, #0b141a 0%, #1c262d 100%); }
        .box { background: var(--panel); padding: 30px; border-radius: 28px; width: 90%; max-width: 340px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.4); }

        .header { padding: 10px 15px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; height: 60px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        /* –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ */
        .chat-item { padding: 16px; border-bottom: 1px solid #1c262d; display: flex; align-items: center; gap: 15px; cursor: pointer; transition: 0.2s; }
        .chat-item:active { background: #2a3942; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #333; margin-left: auto; }
        .status-dot.online { background: #00a884; box-shadow: 0 0 8px #00a884; }

        /* –ß–∞—Ç –∫–∞–∫ –≤ –¢–ì */
        #messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #080e12; }
        .msg { padding: 10px 14px; border-radius: 16px; max-width: 85%; font-size: 15px; position: relative; line-height: 1.4; }
        .msg.in { background: var(--panel); align-self: flex-start; border-bottom-left-radius: 4px; }
        .msg.out { background: var(--msg-out); align-self: flex-end; border-bottom-right-radius: 4px; }
        .msg.pending { opacity: 0.6; }

        input { background: #2a3942; border: none; padding: 14px; color: #fff; border-radius: 12px; width: 100%; font-size: 16px; margin-bottom: 12px; }
        
        .fab { 
            position: fixed; bottom: 30px; right: 25px; width: 56px; height: 56px; 
            background: var(--accent); border-radius: 50%; border: none; 
            color: #fff; font-size: 28px; box-shadow: 0 4px 12px rgba(255,68,68,0.3); z-index: 99; 
        }

        #call-ui { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; flex-direction: column; }
        .remote-v { width: 100%; height: 100%; object-fit: cover; }
        .local-v { position: absolute; top: 40px; right: 20px; width: 100px; height: 150px; border-radius: 12px; border: 2px solid var(--accent); object-fit: cover; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen">
        <div class="box">
            <h1 style="color:var(--accent); margin:0; font-size: 28px;">FearConnect</h1>
            <p style="opacity:0.5; margin-bottom:25px;">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π P2P –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</p>
            <input type="text" id="my-id" placeholder="–í–∞—à –Ω–∏–∫ –∏–ª–∏ –Ω–æ–º–µ—Ä">
            <input type="password" id="my-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="initApp()" style="width:100%; padding:16px; background:var(--accent); border:none; color:#fff; border-radius:14px; font-weight:bold; font-size:16px;">–í–û–ô–¢–ò</button>
        </div>
    </div>

    <div id="list-screen" class="screen hidden-left">
        <div class="header"><b>–ß–∞—Ç—ã</b><small id="id-display" style="opacity:0.4"></small></div>
        <div id="chat-list" style="flex:1; overflow-y:auto;"></div>
        <button class="fab" onclick="showAddModal(true)">+</button>
    </div>

    <div id="chat-screen" class="screen hidden-right">
        <div class="header">
            <button onclick="goBack()" style="background:none; border:none; color:var(--accent); font-size:24px;">‚¨Ö</button>
            <div style="flex:1; margin-left:15px"><b id="chat-title">...</b></div>
            <button onclick="makeCall()" style="background:none; border:none; font-size:22px;">üìû</button>
        </div>
        <div id="messages"></div>
        <div style="padding:10px 15px 30px 15px; background:var(--panel); display:flex; gap:10px; align-items:center;">
            <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0">
            <button onclick="sendMsg()" style="background:var(--accent); border:none; width:48px; height:48px; border-radius:50%; color:#fff; flex-shrink:0;">‚û§</button>
        </div>
    </div>

    <div id="add-modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.85); display:none; align-items:center; justify-content:center; z-index:9000; padding:20px;">
        <div class="box">
            <h3 style="margin-top:0">–ù–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç</h3>
            <input type="text" id="f-id" placeholder="–ù–∏–∫ –¥—Ä—É–≥–∞">
            <input type="text" id="f-name" placeholder="–ò–º—è">
            <button onclick="addFriend()" style="width:100%; padding:14px; background:var(--accent); border:none; color:#fff; border-radius:12px; font-weight:bold;">–î–û–ë–ê–í–ò–¢–¨</button>
            <button onclick="showAddModal(false)" style="background:none; border:none; color:#999; margin-top:15px;">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div id="call-ui">
        <video id="remoteV" class="remote-v" autoplay playsinline></video>
        <video id="localV" class="local-v" autoplay muted playsinline></video>
        <button onclick="location.reload()" style="position:absolute; bottom:50px; left:50%; transform:translateX(-50%); background:#ff3b30; border:none; width:70px; height:70px; border-radius:50%; color:white; font-size:30px; box-shadow: 0 0 20px rgba(255,59,48,0.5);">üìû</button>
    </div>

<script>
    let peer, conn, stream, targetId;
    let chats = JSON.parse(localStorage.getItem('fc_pro_chats') || '{}');
    let pending = JSON.parse(localStorage.getItem('fc_pro_pending') || '[]');

    function initApp() {
        const id = document.getElementById('my-id').value;
        const pass = document.getElementById('my-pass').value;
        if(!id || !pass) return alert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è!");

        const savedPass = localStorage.getItem('upass_' + id);
        if(savedPass && savedPass !== pass) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è —ç—Ç–æ–≥–æ –Ω–∏–∫–∞!");
        localStorage.setItem('upass_' + id, pass);

        peer = new Peer(id, { config: {'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }]} });

        peer.on('open', () => {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('list-screen').classList.add('active');
            document.getElementById('id-display').innerText = id;
            renderList();
            initMedia();
            setInterval(checkPending, 3000);
        });

        peer.on('connection', c => {
            c.on('data', data => handleData(c.peer, data));
            c.on('open', () => updateDot(c.peer, true));
        });

        peer.on('call', call => {
            if(confirm("–í–∞–º –∑–≤–æ–Ω—è—Ç! –û—Ç–≤–µ—Ç–∏—Ç—å?")) {
                call.answer(stream);
                document.getElementById('call-ui').style.display = 'flex';
                call.on('stream', rs => document.getElementById('remoteV').srcObject = rs);
            }
        });
    }

    async function initMedia() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
            document.getElementById('localV').srcObject = stream;
        } catch(e) { console.log("–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"); }
    }

    function addFriend() {
        const id = document.getElementById('f-id').value, name = document.getElementById('f-name').value;
        if(id && name) {
            chats[id] = name;
            localStorage.setItem('fc_pro_chats', JSON.stringify(chats));
            renderList();
            showAddModal(false);
        }
    }

    function renderList() {
        const l = document.getElementById('chat-list'); l.innerHTML = '';
        for(let id in chats) {
            l.innerHTML += `<div class="chat-item" onclick="openChat('${id}')">
                <div style="width:48px; height:48px; background:linear-gradient(45deg, #ff4444, #ff8888); border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold;">${chats[id][0].toUpperCase()}</div>
                <div style="flex:1"><b>${chats[id]}</b><br><small style="opacity:0.4">ID: ${id}</small></div>
                <div id="dot-${id}" class="status-dot"></div>
            </div>`;
        }
    }

    function openChat(id) {
        targetId = id;
        document.getElementById('chat-title').innerText = chats[id];
        document.getElementById('messages').innerHTML = localStorage.getItem('hp_'+id) || '';
        document.getElementById('list-screen').classList.add('hidden-left');
        document.getElementById('chat-screen').classList.add('active');
        connectToFriend();
    }

    function connectToFriend() {
        if(!targetId) return;
        if(!conn || !conn.open) {
            conn = peer.connect(targetId);
            conn.on('open', () => {
                updateDot(targetId, true);
                checkPending();
            });
        }
    }

    function sendMsg() {
        const val = document.getElementById('msg-input').value;
        if(!val) return;
        addMsgUI('–í—ã', val, 'out', targetId, true);
        document.getElementById('msg-input').value = '';

        if(conn && conn.open) {
            conn.send(val);
        } else {
            pending.push({ to: targetId, msg: val });
            localStorage.setItem('fc_pro_pending', JSON.stringify(pending));
            connectToFriend();
        }
    }

    function checkPending() {
        if(!conn || !conn.open) return;
        let myPending = pending.filter(m => m.to === conn.peer);
        if(myPending.length > 0) {
            myPending.forEach(m => conn.send(m.msg));
            pending = pending.filter(m => m.to !== conn.peer);
            localStorage.setItem('fc_pro_pending', JSON.stringify(pending));
            // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            document.querySelectorAll('.msg.pending').forEach(el => el.classList.remove('pending'));
            localStorage.setItem('hp_'+targetId, document.getElementById('messages').innerHTML);
        }
    }

    function handleData(id, data) {
        if(!chats[id]) { chats[id] = id; renderList(); }
        addMsgUI(chats[id], data, 'in', id);
    }

    function addMsgUI(u, t, type, id, isPending = false) {
        const m = document.createElement('div');
        m.className = `msg ${type} ${isPending ? 'pending' : ''}`;
        m.innerHTML = `<small style="font-size:9px;opacity:0.5;display:block;margin-bottom:2px">${u}</small>${t}`;
        const container = document.getElementById('messages');
        container.appendChild(m);
        container.scrollTop = container.scrollHeight;
        localStorage.setItem('hp_'+id, container.innerHTML);
    }

    function goBack() {
        document.getElementById('chat-screen').classList.remove('active');
        document.getElementById('list-screen').classList.remove('hidden-left');
    }

    function updateDot(id, status) {
        const dot = document.getElementById('dot-' + id);
        if(dot) dot.classList.toggle('online', status);
    }

    function makeCall() {
        document.getElementById('call-ui').style.display = 'flex';
        const call = peer.call(targetId, stream);
        call.on('stream', rs => document.getElementById('remoteV').srcObject = rs);
    }

    function showAddModal(s) { document.getElementById('add-modal').style.display = s ? 'flex' : 'none'; }
</script>
</body>
</html>
