<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FearConnect Persistent P2P</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0b141a; color: #e9edef; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        .header { background: #202c33; padding: 15px; text-align: center; border-bottom: 1px solid #333; }
        #my-id { color: #00a884; font-size: 1.2em; cursor: pointer; }
        
        .video-box { display: flex; background: #000; justify-content: center; gap: 5px; }
        video { width: 48%; max-height: 200px; background: #222; border-radius: 8px; }

        #chat { flex: 1; overflow-y: auto; padding: 20px; background: #0b141a; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 8px 12px; border-radius: 8px; max-width: 80%; word-wrap: break-word; font-size: 14px; }
        .incoming { background: #202c33; align-self: flex-start; }
        .outgoing { background: #005c4b; align-self: flex-end; }
        
        .footer { background: #202c33; padding: 15px; display: flex; gap: 10px; align-items: center; }
        input { background: #2a3942; border: none; padding: 10px; color: #fff; border-radius: 8px; flex: 1; outline: none; }
        button { background: #00a884; border: none; color: #fff; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-call { background: #ea0038; }
    </style>
</head>
<body>

<div class="header">
    <strong>FearConnect</strong> | –¢–≤–æ–π ID: <span id="my-id" onclick="copyID()">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
</div>

<div class="video-box">
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
</div>

<div id="chat"></div>

<div class="footer">
    <input type="text" id="friend-id" placeholder="ID –¥—Ä—É–≥–∞" style="max-width: 100px;">
    <input type="text" id="message-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
    <button onclick="sendMessage()">‚û§</button>
    <button class="btn-call" onclick="makeCall()">üìû</button>
    <button onclick="clearHistory()" style="background: #555; font-size: 10px;">–û—á–∏—Å—Ç–∏—Ç—å</button>
</div>

<script>
    const peer = new Peer();
    let conn;
    let localStream;
    const chatDiv = document.getElementById('chat');

    // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑ –ø–∞–º—è—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    window.onload = () => {
        const savedChat = localStorage.getItem('fear_chat_history');
        if (savedChat) {
            chatDiv.innerHTML = savedChat;
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }
        
        navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
            localStream = stream;
            document.getElementById('localVideo').srcObject = stream;
        }).catch(e => console.log("–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"));
    };

    // 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Peer
    peer.on('open', id => document.getElementById('my-id').innerText = id);

    // –°–ª—É—à–∞–µ–º –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    peer.on('connection', connection => {
        conn = connection;
        setupConn();
    });

    // –°–ª—É—à–∞–µ–º –≤—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏
    peer.on('call', call => {
        if (confirm("–í—Ö–æ–¥—è—â–∏–π –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫! –ü—Ä–∏–Ω—è—Ç—å?")) {
            call.answer(localStream);
            call.on('stream', stream => document.getElementById('remoteVideo').srcObject = stream);
        }
    });

    function connectToFriend() {
        const fId = document.getElementById('friend-id').value;
        if (!fId) return alert("–í–≤–µ–¥–∏ ID!");
        conn = peer.connect(fId);
        setupConn();
    }

    function setupConn() {
        conn.on('open', () => {
            addMessage('–°–∏—Å—Ç–µ–º–∞', '–°–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'incoming');
            conn.on('data', data => addMessage('–î—Ä—É–≥', data, 'incoming'));
        });
    }

    // 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç—å
    function addMessage(user, text, type) {
        const mDiv = document.createElement('div');
        mDiv.className = `msg ${type}`;
        mDiv.innerHTML = `<small style="opacity:0.5">${user}</small><br>${text}`;
        chatDiv.appendChild(mDiv);
        chatDiv.scrollTop = chatDiv.scrollHeight;

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–µ—Å—å HTML —á–∞—Ç–∞ –≤ localStorage
        localStorage.setItem('fear_chat_history', chatDiv.innerHTML);
    }

    function sendMessage() {
        const input = document.getElementById('message-input');
        const text = input.value;
        const fId = document.getElementById('friend-id').value;

        if (!conn || !conn.open) {
            connectToFriend();
            setTimeout(() => { if(conn.open) send(); }, 1000);
        } else {
            send();
        }

        function send() {
            if (!text) return;
            conn.send(text);
            addMessage('–Ø', text, 'outgoing');
            input.value = '';
        }
    }

    async function makeCall() {
        const fId = document.getElementById('friend-id').value;
        if (!fId) return alert("–í–≤–µ–¥–∏ ID –¥—Ä—É–≥–∞ –¥–ª—è –∑–≤–æ–Ω–∫–∞!");
        const call = peer.call(fId, localStream);
        call.on('stream', stream => document.getElementById('remoteVideo').srcObject = stream);
    }

    function clearHistory() {
        if (confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å—é –ø–µ—Ä–µ–ø–∏—Å–∫—É –∏–∑ –ø–∞–º—è—Ç–∏?")) {
            localStorage.removeItem('fear_chat_history');
            chatDiv.innerHTML = '';
        }
    }

    function copyID() {
        const id = document.getElementById('my-id').innerText;
        navigator.clipboard.writeText(id);
        alert("–¢–≤–æ–π ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: " + id);
    }
</script>

</body>
</html>
