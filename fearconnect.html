<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CyberGram OS v5</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root { --bg: #05070a; --panel: #101216; --accent: #0088cc; --text: #e0e0e0; --danger: #ff3b30; --success: #4cd964; }
        body, html { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; height: 100vh; overflow: hidden; }
        
        /* –≠–∫—Ä–∞–Ω—ã */
        .screen { position: fixed; inset: 0; display: none; flex-direction: column; background: var(--bg); z-index: 10; }
        #boot-screen { display: flex; align-items: center; justify-content: center; text-align: center; z-index: 100; }
        #lock-screen { align-items: center; justify-content: center; z-index: 90; }
        
        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        header { padding: 15px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; }
        .content { flex: 1; overflow-y: auto; padding: 15px; }
        .card { background: var(--panel); padding: 15px; border-radius: 15px; margin-bottom: 10px; display: flex; align-items: center; border: 1px solid #222; }
        .avatar { width: 45px; height: 45px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-weight: bold; color: #fff; }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .btn { padding: 10px 20px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: #fff; }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-success { background: var(--success); color: #fff; }
        
        /* –ß–∞—Ç */
        .messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 70%; padding: 10px 15px; border-radius: 15px; font-size: 14px; line-height: 1.4; }
        .msg.me { align-self: flex-end; background: var(--accent); color: #fff; border-bottom-right-radius: 2px; }
        .msg.them { align-self: flex-start; background: var(--panel); border-bottom-left-radius: 2px; }

        /* –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ */
        #call-ui { position: fixed; inset: 0; background: #000; z-index: 1000; display: none; }
        #remote-v { width: 100%; height: 100%; object-fit: cover; }
        #local-v { position: absolute; top: 20px; right: 20px; width: 110px; aspect-ratio: 3/4; border-radius: 12px; border: 2px solid var(--accent); object-fit: cover; transform: scaleX(-1); }
        .controls { position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: center; gap: 20px; }
        
        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
        .s-row { padding: 15px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        select { background: #000; color: #fff; border: 1px solid #444; padding: 8px; border-radius: 5px; }

        /* –ú–æ–¥–∞–ª–∫–∏ */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-body { background: var(--panel); padding: 25px; border-radius: 20px; width: 85%; max-width: 320px; border: 1px solid var(--accent); }
        input { width: 100%; box-sizing: border-box; background: #000; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 10px; margin-bottom: 15px; outline: none; }
    </style>
</head>
<body>

<div id="boot-screen" class="screen">
    <div>
        <h2 id="geo-status">Detecting Location...</h2>
        <button class="btn btn-primary" id="lang-btn" onclick="startApp()">Continue</button>
    </div>
</div>

<div id="lock-screen" class="screen">
    <h1>CYBERGRAM</h1>
    <input type="password" id="pin-input" placeholder="PIN" maxlength="4" style="width: 120px; text-align: center; font-size: 24px;">
    <button class="btn btn-primary" onclick="unlock()">CONNECT</button>
</div>

<div id="main-screen" class="screen">
    <header>
        <span onclick="openSettings()">‚öôÔ∏è</span>
        <b>ID: <span id="my-id">....</span></b>
        <span onclick="location.reload()">üö™</span>
    </header>
    <div class="content" id="contact-list"></div>
    <button style="position:fixed; bottom:20px; right:20px; width:60px; height:60px; border-radius:50%; font-size:30px;" class="btn btn-primary" onclick="showModal()">+</button>
</div>

<div id="chat-screen" class="screen">
    <header>
        <span onclick="closeChat()">‚¨ÖÔ∏è</span>
        <b id="active-name">User</b>
        <span onclick="startCall()">üìû</span>
    </header>
    <div id="chat-tools" style="background:#1a1d23; padding:10px; display:flex; gap:10px; justify-content:center;">
        <button class="btn btn-success" style="padding:5px 10px; font-size:12px;" onclick="showModal(currentPeer)">EDIT</button>
        <button class="btn btn-danger" style="padding:5px 10px; font-size:12px;" onclick="banUser(currentPeer)">BAN</button>
    </div>
    <div class="messages" id="chat-msgs"></div>
    <div style="padding:15px; background:var(--panel); display:flex; gap:10px;">
        <input type="text" id="msg-input" placeholder="Message..." style="margin:0;">
        <button class="btn btn-primary" onclick="sendMsg()">‚ûú</button>
    </div>
</div>

<div id="call-ui">
    <video id="remote-v" autoplay playsinline></video>
    <video id="local-v" autoplay playsinline muted></video>
    <div class="controls">
        <button id="answer-btn" class="btn btn-success" style="display:none; border-radius:50%; width:70px; height:70px;" onclick="answerCall()">‚úî</button>
        <button class="btn btn-danger" style="border-radius:50%; width:70px; height:70px;" onclick="endCall(true)">üõë</button>
    </div>
    <audio id="ringtone" loop src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"></audio>
</div>

<div id="settings-screen" class="screen">
    <header><span onclick="closeSettings()">‚¨ÖÔ∏è</span><b>Settings</b><span></span></header>
    <div class="s-row">
        <span>Language</span>
        <select id="lang-sel" onchange="setLang(this.value)">
            <option value="ru">–†—É—Å—Å–∫–∏–π</option><option value="en">English</option>
            <option value="zh">‰∏≠Êñá</option><option value="ja">Êó•Êú¨Ë™û</option>
            <option value="de">Deutsch</option><option value="fr">Fran√ßais</option>
        </select>
    </div>
    <div class="s-row" style="color:var(--danger)" onclick="localStorage.clear(); location.reload();">Clear All Data</div>
</div>

<div id="modal-ui" class="modal">
    <div class="modal-body">
        <h3 id="modal-title">Contact</h3>
        <input type="text" id="edit-name" placeholder="Name">
        <input type="number" id="edit-id" placeholder="ID">
        <div style="display:flex; gap:10px;">
            <button class="btn" style="flex:1; background:#333; color:#fff;" onclick="hideModal()">Cancel</button>
            <button class="btn btn-primary" style="flex:1" onclick="saveContact()">Save</button>
        </div>
    </div>
</div>

<script>
    const PIN = "1234";
    const myID = Math.floor(1000 + Math.random() * 9000).toString();
    document.getElementById('my-id').innerText = myID;

    let friends = JSON.parse(localStorage.getItem('f_v5') || '[]');
    let bans = JSON.parse(localStorage.getItem('b_v5') || '[]');
    let currentPeer = null, mqttClient, pc, localStream;

    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –Ø–∑—ã–∫
    const isRU = navigator.language.startsWith('ru');
    document.getElementById('geo-status').innerText = isRU ? "–í–∞—à —è–∑—ã–∫: –†—É—Å—Å–∫–∏–π" : "Language: English";
    document.getElementById('lang-btn').innerText = isRU ? "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" : "Continue";

    function startApp() {
        document.getElementById('boot-screen').style.display = 'none';
        document.getElementById('lock-screen').style.display = 'flex';
    }

    function unlock() {
        if(document.getElementById('pin-input').value === PIN) {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('main-screen').style.display = 'flex';
            initNetwork(); renderList();
        } else alert("Wrong PIN");
    }

    // 2. –°–µ—Ç—å (MQTT + WebRTC)
    function initNetwork() {
        mqttClient = mqtt.connect('wss://broker.emqx.io:8084/mqtt');
        mqttClient.on('connect', () => mqttClient.subscribe(`cyber/v5/${myID}`));
        mqttClient.on('message', async (t, m) => {
            const d = JSON.parse(m.toString());
            if(bans.includes(d.from)) return;

            if(d.type === 'text') {
                pushMsg(d.from, 'them', d.val);
            } else if(d.type === 'offer') {
                currentPeer = d.from;
                window.incoming = d.val;
                document.getElementById('call-ui').style.display = 'block';
                document.getElementById('answer-btn').style.display = 'block';
                document.getElementById('ringtone').play();
            } else if(d.type === 'answer') {
                await pc.setRemoteDescription(new RTCSessionDescription(d.val));
            } else if(d.type === 'ice') {
                if(pc) pc.addIceCandidate(new RTCIceCandidate(d.val));
            } else if(d.type === 'end') location.reload();
        });
    }

    // 3. –ó–≤–æ–Ω–∫–∏
    async function getMedia() {
        localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
        document.getElementById('local-v').srcObject = localStream;
    }

    function createConn() {
        pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
        localStream.getTracks().forEach(tr => pc.addTrack(tr, localStream));
        pc.onicecandidate = e => e.candidate && send('ice', e.candidate);
        pc.ontrack = e => document.getElementById('remote-v').srcObject = e.streams[0];
    }

    async function startCall() {
        document.getElementById('call-ui').style.display = 'block';
        await getMedia(); createConn();
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        send('offer', offer);
    }

    async function answerCall() {
        document.getElementById('ringtone').pause();
        document.getElementById('answer-btn').style.display = 'none';
        await getMedia(); createConn();
        await pc.setRemoteDescription(new RTCSessionDescription(window.incoming));
        const ans = await pc.createAnswer();
        await pc.setLocalDescription(ans);
        send('answer', ans);
    }

    function endCall(notify) {
        if(notify) send('end', {});
        location.reload();
    }

    function send(type, val) {
        mqttClient.publish(`cyber/v5/${currentPeer}`, JSON.stringify({type, from:myID, val}));
    }

    // 4. –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    function renderList() {
        const c = document.getElementById('contact-list');
        c.innerHTML = friends.length ? "" : "<p style='text-align:center; opacity:0.5'>No contacts</p>";
        friends.forEach(f => {
            const d = document.createElement('div');
            d.className = 'card';
            d.onclick = () => openChat(f.id, f.name);
            d.innerHTML = `<div class="avatar">${f.name[0]}</div><div style="flex:1"><b>${f.name}</b><br><small>ID: ${f.id}</small></div>
            <button class="btn btn-danger" style="padding:5px" onclick="event.stopPropagation(); deleteUser('${f.id}')">‚úï</button>`;
            c.appendChild(d);
        });
    }

    function openChat(id, name) {
        currentPeer = id;
        document.getElementById('active-name').innerText = name;
        document.getElementById('chat-screen').style.display = 'flex';
        renderMsgs();
    }

    function closeChat() { document.getElementById('chat-screen').style.display = 'none'; }

    function sendMsg() {
        const i = document.getElementById('msg-input');
        if(!i.value) return;
        send('text', i.value);
        pushMsg(currentPeer, 'me', i.value);
        i.value = "";
    }

    let logs = {};
    function pushMsg(id, side, val) {
        if(!logs[id]) logs[id] = [];
        logs[id].push({side, val});
        if(currentPeer === id) renderMsgs();
    }

    function renderMsgs() {
        const b = document.getElementById('chat-msgs');
        b.innerHTML = "";
        (logs[currentPeer] || []).forEach(m => {
            const d = document.createElement('div');
            d.className = `msg ${m.side}`; d.innerText = m.val;
            b.appendChild(d);
        });
        b.scrollTop = b.scrollHeight;
    }

    // 5. –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –ë–∞–Ω
    function showModal(id = "") {
        document.getElementById('modal-ui').style.display = 'flex';
        document.getElementById('edit-id').value = id;
    }
    function hideModal() { document.getElementById('modal-ui').style.display = 'none'; }
    function saveContact() {
        const n = document.getElementById('edit-name').value;
        const i = document.getElementById('edit-id').value;
        if(n && i) {
            friends = friends.filter(f => f.id !== i.toString());
            friends.push({name:n, id:i.toString()});
            localStorage.setItem('f_v5', JSON.stringify(friends));
            renderList(); hideModal();
        }
    }

    function deleteUser(id) {
        friends = friends.filter(f => f.id !== id);
        localStorage.setItem('f_v5', JSON.stringify(friends));
        renderList();
    }

    function banUser(id) {
        if(confirm("Ban ID " + id + "?")) {
            bans.push(id);
            localStorage.setItem('b_v5', JSON.stringify(bans));
            closeChat();
        }
    }

    function openSettings() { document.getElementById('settings-screen').style.display = 'flex'; }
    function closeSettings() { document.getElementById('settings-screen').style.display = 'none'; }
    function setLang(v) { console.log("Lang set to " + v); }
</script>
</body>
</html>
