<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FearConnect v1.2</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: #fff; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #auth-box { margin: auto; background: #1e1e1e; padding: 25px; border-radius: 12px; text-align: center; border: 1px solid #333; width: 300px; z-index: 100; }
        input { padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid #444; background: #252525; color: #fff; width: 90%; font-size: 16px; }
        button { padding: 12px; border-radius: 6px; border: none; background: #ff4444; color: #fff; cursor: pointer; font-weight: bold; width: 95%; margin: 5px 0; font-size: 14px; }
        button:disabled { background: #555; cursor: not-allowed; }
        #main-box { display: none; flex-direction: column; height: 100%; }
        .vids { display: flex; background: #000; justify-content: center; min-height: 200px; }
        video { width: 50%; max-width: 400px; background: #222; border: 1px solid #333; }
        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; background: #181818; }
        .m { background: #333; padding: 8px 12px; border-radius: 8px; width: fit-content; max-width: 80%; }
        .my { background: #ff4444; align-self: flex-end; }
        .bar { background: #1e1e1e; padding: 15px; display: flex; gap: 10px; }
        #conn-status { font-size: 12px; color: #ffaa00; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="auth-box">
        <h1>FEAR CONNECT</h1>
        <div id="conn-status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...</div>
        <input type="text" id="loginInput" placeholder="–¢–≤–æ–π ID (–õ–æ–≥–∏–Ω)">
        <input type="password" id="passInput" placeholder="–ü–∞—Ä–æ–ª—å">
        <button id="regBtn" onclick="handleAuth(true)" disabled>–°–û–ó–î–ê–¢–¨ –ê–ö–ö–ê–£–ù–¢</button>
        <button id="loginBtn" onclick="handleAuth(false)" disabled>–í–û–ô–¢–ò</button>
    </div>

    <div id="main-box">
        <div class="vids">
            <video id="localV" autoplay muted playsinline></video>
            <video id="remoteV" autoplay playsinline></video>
        </div>
        <div id="chat"></div>
        <div class="bar">
            <input type="text" id="targetID" placeholder="–ö–û–ú–£ (ID)" style="width:70px">
            <input type="text" id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1">
            <button onclick="sendMsg()" style="width:auto">‚û§</button>
            <button onclick="makeCall()" style="width:auto">üìû</button>
        </div>
    </div>

    <script>
        // –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ê–î–†–ï–°–ê
        let ws;
        function connect() {
            let protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            let host = window.location.host;
            ws = new WebSocket(protocol + host);

            ws.onopen = () => {
                console.log("Connected!");
                document.getElementById('conn-status').innerText = "‚úÖ –û–Ω–ª–∞–π–Ω";
                document.getElementById('conn-status').style.color = "#00ff00";
                document.getElementById('regBtn').disabled = false;
                document.getElementById('loginBtn').disabled = false;
            };

            ws.onclose = () => {
                document.getElementById('conn-status').innerText = "‚ùå –û—Ñ–ª–∞–π–Ω (–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...)";
                document.getElementById('conn-status').style.color = "#ff4444";
                setTimeout(connect, 2000);
            };

            ws.onmessage = async (e) => {
                const d = JSON.parse(e.data);
                if (d.type === 'auth_ok') {
                    document.getElementById('auth-box').style.display = 'none';
                    document.getElementById('main-box').style.display = 'flex';
                    const stream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
                    document.getElementById('localV').srcObject = stream;
                    window.localStream = stream; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –∑–≤–æ–Ω–∫–æ–≤
                }
                if (d.type === 'error') alert("–û—à–∏–±–∫–∞: " + d.msg);
                if (d.type === 'new_msg') {
                    const m = document.createElement('div');
                    m.className = 'm' + (d.from === document.getElementById('loginInput').value ? ' my' : '');
                    m.innerHTML = `<b>${d.from}:</b> ${d.text}`;
                    document.getElementById('chat').appendChild(m);
                }
                // –õ–æ–≥–∏–∫–∞ –∑–≤–æ–Ω–∫–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
                if (d.type === 'offer') {
                    if(confirm("–ó–≤–æ–Ω–∏—Ç " + d.from)) { /* —Ç—É—Ç –ª–æ–≥–∏–∫–∞ WebRTC –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ –∫–æ–¥–∞ */ }
                }
            };
        }

        function handleAuth(isReg) {
            const login = document.getElementById('loginInput').value;
            const pass = document.getElementById('passInput').value;
            if(!login || !pass) return alert("–í–≤–µ–¥–∏ –¥–∞–Ω–Ω—ã–µ!");
            ws.send(JSON.stringify({ type: 'auth', login, pass, isReg }));
        }

        function sendMsg() {
            const text = document.getElementById('msgInput').value;
            const to = document.getElementById('targetID').value;
            ws.send(JSON.stringify({ type: 'msg', to, text }));
            document.getElementById('msgInput').value = '';
        }

        connect(); // –ó–∞–ø—É—Å–∫
    </script>
</body>
</html>
