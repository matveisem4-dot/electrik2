<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FearConnect V21</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #09090b; --panel: #18181b; --accent: #3b82f6; --text: #f4f4f5; --red: #ef4444; --green: #22c55e; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        .screen { position: absolute; inset: 0; display: none; flex-direction: column; background: var(--bg); }
        .active { display: flex; }

        /* –ö–æ–Ω—Ç–∞–∫—Ç—ã */
        .chat-card { background: var(--panel); margin: 8px 12px; padding: 15px; border-radius: 16px; display: flex; align-items: center; border: 1px solid #27272a; cursor: pointer; position: relative; }
        .av-circle { width: 48px; height: 48px; background: #27272a; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-right: 15px; border: 2px solid transparent; }
        .av-circle.is-online { border-color: var(--green); }
        
        .info b { display: block; font-size: 16px; margin-bottom: 2px; }
        .info span { font-size: 12px; color: #71717a; }

        /* –§–æ—Ä–º—ã */
        .input-area { padding: 20px; background: var(--panel); border-top: 1px solid #27272a; }
        input { background: #09090b; border: 1px solid #27272a; color: #fff; padding: 12px 16px; width: 100%; border-radius: 10px; margin-bottom: 10px; font-size: 16px; }
        .btn { background: var(--accent); color: #fff; border: none; padding: 14px; border-radius: 10px; font-weight: 600; width: 100%; cursor: pointer; transition: 0.2s; }
        .btn:active { opacity: 0.7; transform: scale(0.98); }

        /* –ß–∞—Ç */
        #msg-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .bubble { padding: 10px 16px; border-radius: 18px; max-width: 80%; font-size: 15px; line-height: 1.4; position: relative; }
        .bubble.sent { background: var(--accent); align-self: flex-end; border-bottom-right-radius: 4px; }
        .bubble.recv { background: #27272a; align-self: flex-start; border-bottom-left-radius: 4px; }

        /* –ú–æ–¥–∞–ª–∫–∏ */
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal { background: var(--panel); padding: 25px; border-radius: 20px; width: 100%; max-width: 350px; border: 1px solid #27272a; }

        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; background: #52525b; }
        .status-dot.on { background: var(--green); box-shadow: 0 0 5px var(--green); }
    </style>
</head>
<body>

    <div id="login-s" class="screen active" style="justify-content:center; padding:40px;">
        <h1 style="font-size:32px; text-align:center; margin-bottom:10px;">FearConnect</h1>
        <p style="text-align:center; color:#71717a; margin-bottom:40px;">–õ–æ–∫–∞–ª—å–Ω–∞—è –ë–∞–∑–∞ V21</p>
        
        <div id="p-av" style="font-size:60px; text-align:center; margin-bottom:20px; cursor:pointer;" onclick="nextAv()">üë§</div>
        <input type="text" id="p-id" placeholder="–¢–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID">
        <button class="btn" onclick="login()">–í–û–ô–¢–ò –í –°–ï–¢–¨</button>
    </div>

    <div id="list-s" class="screen">
        <div style="padding:50px 20px 20px; display:flex; justify-content:space-between; align-items:center;">
            <h2>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
            <div id="me-info" style="font-size:12px; background:#27272a; padding:5px 10px; border-radius:20px;"></div>
        </div>
        <div id="contacts-list" style="flex:1; overflow-y:auto;"></div>
        <div class="input-area">
            <button class="btn" onclick="openAdd()">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ ID</button>
        </div>
    </div>

    <div id="chat-s" class="screen">
        <div style="padding:50px 20px 15px; background:var(--panel); display:flex; align-items:center; gap:15px; border-bottom:1px solid #27272a;">
            <button onclick="toScreen('list-s')" style="background:none; border:none; color:var(--accent); font-size:20px;">‚¨Ö</button>
            <div id="c-av-head" style="font-size:24px;">üë§</div>
            <div style="flex:1">
                <b id="c-name">–ò–º—è</b><br>
                <small id="c-status" style="color:#71717a">–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏...</small>
            </div>
            <button onclick="call()" style="background:none; border:none; font-size:22px;">üìû</button>
        </div>
        <div id="msg-box"></div>
        <div class="input-area" style="display:flex; gap:10px; padding:10px 15px 30px;">
            <input type="text" id="m-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0;">
            <button class="btn" style="width:60px;" onclick="send()">‚û§</button>
        </div>
    </div>

    <div id="overlay">
        <div class="modal">
            <h3 style="margin-bottom:15px;">–ù–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç</h3>
            <input type="text" id="f-id" placeholder="ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <input type="text" id="f-name" placeholder="–ò–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ë—Ä–∞—Ç)">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn" style="background:#27272a;" onclick="closeAdd()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn" onclick="confirmAdd()">–ù–∞–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <script>
        let peer, myId, myAv = 'üë§', targetId;
        let db = JSON.parse(localStorage.getItem('fc_db') || '{}');
        const avs = ['üë§','üíÄ','ü§ñ','üëΩ','üëª','üê±','üê∂','ü¶ä','üêª','ü¶Å'];

        function nextAv() {
            myAv = avs[(avs.indexOf(myAv) + 1) % avs.length];
            document.getElementById('p-av').innerText = myAv;
        }

        function login() {
            myId = document.getElementById('p-id').value.trim().toLowerCase();
            if(!myId) return;
            
            peer = new Peer(myId, { config: {'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }]} });
            
            peer.on('open', (id) => {
                document.getElementById('me-info').innerText = myAv + " " + id;
                toScreen('list-s');
                render();
                setInterval(checkOnline, 5000);
            });

            peer.on('connection', c => {
                c.on('data', d => {
                    if(d.type === 'msg') {
                        saveMsg(c.peer, d.txt, 'recv');
                        if(targetId === c.peer) renderMsgs(c.peer);
                    }
                    if(d.type === 'info') {
                        if(db[c.peer]) {
                            db[c.peer].av = d.av;
                            save(); render();
                        }
                    }
                });
            });
        }

        // --- –ë–ê–ó–ê –î–ê–ù–ù–´–•: –ü–û–ò–°–ö –ò –ü–†–û–í–ï–†–ö–ê ---
        function confirmAdd() {
            const id = document.getElementById('f-id').value.trim().toLowerCase();
            const name = document.getElementById('f-name').value.trim() || id;
            
            if(!id || id === myId) return alert("–û—à–∏–±–∫–∞ ID");

            // –ù–∞—à–∞ "–ë–∞–∑–æ–≤–∞—è –ë–∞–∑–∞" –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ PeerJS
            const conn = peer.connect(id);
            let found = false;

            // –ï—Å–ª–∏ –∑–∞ 3 —Å–µ–∫—É–Ω–¥—ã –Ω–µ –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å - –∑–Ω–∞—á–∏—Ç ID –Ω–µ –≤ —Å–µ—Ç–∏ –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            const timeout = setTimeout(() => {
                if(!found) alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–µ—Ç–∏. –ù–æ –º—ã –¥–æ–±–∞–≤–∏–ª–∏ –µ–≥–æ –≤ —Å–ø–∏—Å–æ–∫ –æ–∂–∏–¥–∞–Ω–∏—è.");
                saveContact(id, name, 'üë§');
                closeAdd();
            }, 3000);

            conn.on('open', () => {
                found = true;
                clearTimeout(timeout);
                saveContact(id, name, 'üë§');
                conn.send({type: 'info', av: myAv}); // –ü—Ä–æ—Å–∏–º –¥–∞–Ω–Ω—ã–µ
                closeAdd();
            });
        }

        function saveContact(id, name, av) {
            db[id] = { name, av, online: false };
            save(); render();
        }

        function checkOnline() {
            Object.keys(db).forEach(id => {
                const c = peer.connect(id);
                c.on('open', () => { 
                    db[id].online = true; 
                    render(); 
                    c.send({type: 'info', av: myAv}); 
                    c.close(); 
                });
                setTimeout(() => { if(!c.open) { db[id].online = false; render(); } }, 2000);
            });
        }

        // --- –ò–ù–¢–ï–†–§–ï–ô–° ---
        function render() {
            const list = document.getElementById('contacts-list');
            list.innerHTML = '';
            for(let id in db) {
                const u = db[id];
                list.innerHTML += `
                    <div class="chat-card" onclick="openChat('${id}')">
                        <div class="av-circle ${u.online ? 'is-online' : ''}">${u.av}</div>
                        <div class="info">
                            <b>${u.name}</b>
                            <span>${u.online ? '–í —Å–µ—Ç–∏' : '–û—Ñ–ª–∞–π–Ω'} | ID: ${id}</span>
                        </div>
                    </div>
                `;
            }
        }

        function openChat(id) {
            targetId = id;
            document.getElementById('c-name').innerText = db[id].name;
            document.getElementById('c-av-head').innerText = db[id].av;
            document.getElementById('c-status').innerText = db[id].online ? '–≤ —Å–µ—Ç–∏' : '–æ—Ñ–ª–∞–π–Ω';
            renderMsgs(id);
            toScreen('chat-s');
        }

        function send() {
            const inp = document.getElementById('m-input');
            if(!inp.value) return;
            const txt = inp.value;

            const c = peer.connect(targetId);
            c.on('open', () => {
                c.send({type: 'msg', txt: txt});
                saveMsg(targetId, txt, 'sent');
                renderMsgs(targetId);
                inp.value = '';
            });
        }

        function saveMsg(id, txt, dir) {
            let h = JSON.parse(localStorage.getItem('msgs_'+id) || '[]');
            h.push({txt, dir});
            localStorage.setItem('msgs_'+id, JSON.stringify(h));
        }

        function renderMsgs(id) {
            const box = document.getElementById('msg-box');
            box.innerHTML = '';
            let h = JSON.parse(localStorage.getItem('msgs_'+id) || '[]');
            h.forEach(m => {
                box.innerHTML += `<div class="bubble ${m.dir}">${m.txt}</div>`;
            });
            box.scrollTop = box.scrollHeight;
        }

        function toScreen(s) {
            document.querySelectorAll('.screen').forEach(x => x.classList.remove('active'));
            document.getElementById(s).classList.add('active');
        }

        function openAdd() { document.getElementById('overlay').style.display = 'flex'; }
        function closeAdd() { document.getElementById('overlay').style.display = 'none'; }
        function save() { localStorage.setItem('fc_db', JSON.stringify(db)); }
    </script>
</body>
</html>
