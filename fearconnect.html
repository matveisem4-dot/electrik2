<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FearConnect Iron</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #000; --panel: #1a1a1a; --accent: #ff3b30; --text: #fff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
        
        body, html { 
            margin: 0; padding: 0; height: 100%; background: #111; color: var(--text); 
            font-family: -apple-system, sans-serif; overflow: hidden;
        }

        /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –Ω–∞ –∫–æ–º–ø–µ, —á—Ç–æ–±—ã –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–ª–æ—Å—å */
        .app-container {
            max-width: 500px; margin: 0 auto; height: 100%; background: var(--bg);
            position: relative; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        .screen { position: absolute; inset: 0; display: none; flex-direction: column; background: var(--bg); }
        .screen.active { display: flex; }

        /* –®–∞–ø–∫–∞ */
        .header { padding: 40px 20px 15px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        
        /* –ß–∞—Ç */
        #messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #000; }
        .msg { padding: 12px 16px; border-radius: 18px; max-width: 80%; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .msg.in { background: #262629; align-self: flex-start; }
        .msg.out { background: var(--accent); align-self: flex-end; }

        /* –í–∏–¥–µ–æ –∑–≤–æ–Ω–æ–∫ */
        #call-ui { position: absolute; inset: 0; background: #000; z-index: 1000; display: none; flex-direction: column; }
        #remoteV { width: 100%; height: 100%; object-fit: cover; }
        
        /* –ü–ª–∞–≤–∞—é—â–µ–µ –æ–∫–Ω–æ (—Ç–≤–æ–µ –≤–∏–¥–µ–æ) */
        #local-container { 
            position: absolute; top: 70px; right: 20px; width: 100px; height: 150px; 
            border-radius: 12px; overflow: hidden; border: 2px solid var(--accent); 
            z-index: 1001; cursor: move; touch-action: none; background: #222;
        }
        #localV { width: 100%; height: 100%; object-fit: cover; }

        .controls { position: absolute; bottom: 30px; left: 0; right: 0; display: flex; justify-content: center; gap: 15px; padding: 0 20px; }
        .btn { width: 55px; height: 55px; border-radius: 50%; border: none; background: rgba(255,255,255,0.1); color: #fff; font-size: 20px; backdrop-filter: blur(10px); }
        .btn.red { background: var(--accent); width: 80px; border-radius: 20px; }
        .btn.active { background: #fff; color: #000; }

        /* –í—Ö–æ–¥ */
        .input-group { width: 85%; margin: 0 auto; display: flex; flex-direction: column; gap: 10px; }
        input { background: #222; border: 1px solid #333; padding: 15px; color: #fff; border-radius: 12px; font-size: 16px; user-select: text !important; }
        
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--accent); padding: 10px 20px; border-radius: 10px; z-index: 2000; display: none; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="toast"></div>

    <div id="login-screen" class="screen active" style="justify-content:center;">
        <div class="input-group">
            <h1 style="text-align:center; color:var(--accent); margin:0;">FearConnect</h1>
            <p style="text-align:center; opacity:0.5;">–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ</p>
            <input type="text" id="my-id" placeholder="–í–∞—à ID">
            <input type="password" id="my-pass" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å">
            <button onclick="startApp()" style="padding:15px; background:var(--accent); border:none; color:#fff; border-radius:12px; font-weight:bold;">–í–û–ô–¢–ò</button>
        </div>
    </div>

    <div id="list-screen" class="screen">
        <div class="header"><h3>–ß–∞—Ç—ã</h3><b id="me-tag" style="color:var(--accent)"></b></div>
        <div id="chat-list" style="flex:1; overflow-y:auto;"></div>
        <button onclick="showAdd(true)" style="position:absolute; bottom:30px; right:20px; width:60px; height:60px; border-radius:50%; background:var(--accent); border:none; font-size:30px; color:#fff;">+</button>
    </div>

    <div id="chat-screen" class="screen">
        <div class="header">
            <button onclick="goBack()" style="background:none; border:none; color:var(--accent); font-size:20px;">‚¨Ö</button>
            <b id="chat-title">–ß–∞—Ç</b>
            <button onclick="makeCall()" style="background:none; border:none; font-size:20px;">üìû</button>
        </div>
        <div id="messages"></div>
        <div style="padding:10px 15px 30px; display:flex; gap:10px; background:var(--panel);">
            <input type="text" id="msg-input" style="flex:1; border-radius:20px;" placeholder="–¢–µ–∫—Å—Ç...">
            <button onclick="sendMsg()" style="background:var(--accent); border:none; width:45px; height:45px; border-radius:50%; color:#fff;">‚û§</button>
        </div>
    </div>

    <div id="call-ui">
        <video id="remoteV" autoplay playsinline></video>
        <div id="local-container">
            <video id="localV" autoplay muted playsinline></video>
        </div>
        <div class="controls">
            <button id="m-btn" class="btn" onclick="toggleTrack('audio')">üé§</button>
            <button id="v-btn" class="btn" onclick="toggleTrack('video')">üì∑</button>
            <button class="btn red" onclick="endCall()">–°–ë–†–û–°</button>
        </div>
    </div>
</div>

<div id="add-modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; z-index:5000;">
    <div class="input-group" style="background:#222; padding:20px; border-radius:20px;">
        <input type="text" id="f-id" placeholder="ID –¥—Ä—É–≥–∞">
        <input type="text" id="f-name" placeholder="–ò–º—è">
        <button onclick="addFriend()" style="padding:15px; background:var(--accent); border:none; color:#fff; border-radius:12px;">–î–û–ë–ê–í–ò–¢–¨</button>
        <button onclick="showAdd(false)" style="background:none; border:none; color:#555;">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<script>
    let peer, conn, targetId, myStream, currentCall;
    let chats = JSON.parse(localStorage.getItem('fc_v13_chats') || '{}');

    function notify(text) {
        const t = document.getElementById('toast');
        t.innerText = text; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
    }

    function startApp() {
        const id = document.getElementById('my-id').value.trim();
        const pass = document.getElementById('my-pass').value.trim();
        if(!id || !pass) return notify("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è");

        const saved = localStorage.getItem('up_'+id);
        if(saved && saved !== pass) return notify("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
        localStorage.setItem('up_'+id, pass);

        peer = new Peer(id, { 
            config: { 'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] },
            debug: 1 
        });

        peer.on('open', () => {
            switchScreen('list-screen');
            document.getElementById('me-tag').innerText = id;
            renderList();
            initMedia();
        });

        peer.on('connection', c => {
            conn = c;
            c.on('data', d => handleData(c.peer, d));
        });

        peer.on('call', call => {
            if(confirm("–í–∞–º –∑–≤–æ–Ω—è—Ç! –û—Ç–≤–µ—Ç–∏—Ç—å?")) {
                currentCall = call;
                call.answer(myStream);
                document.getElementById('call-ui').style.display = 'flex';
                call.on('stream', rs => { document.getElementById('remoteV').srcObject = rs; });
            }
        });

        peer.on('error', e => notify("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ ID –∑–∞–Ω—è—Ç"));
    }

    async function initMedia() {
        try {
            // –≠—Ö–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è –∑–¥–µ—Å—å
            myStream = await navigator.mediaDevices.getUserMedia({
                video: { width: 480, height: 640 },
                audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
            });
            document.getElementById('localV').srcObject = myStream;
        } catch(e) { notify("–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"); }
    }

    function sendMsg() {
        const i = document.getElementById('msg-input');
        if(!i.value || !targetId) return;

        const data = i.value;
        const attemptSend = () => {
            if(conn && conn.open) {
                conn.send(data);
                addMsgUI('–í—ã', data, 'out', targetId);
                i.value = '';
            } else {
                conn = peer.connect(targetId);
                conn.on('open', () => { conn.send(data); addMsgUI('–í—ã', data, 'out', targetId); i.value = ''; });
            }
        };
        attemptSend();
    }

    function makeCall() {
        if(!myStream) return notify("–ö–∞–º–µ—Ä–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞");
        document.getElementById('call-ui').style.display = 'flex';
        currentCall = peer.call(targetId, myStream);
        currentCall.on('stream', rs => { document.getElementById('remoteV').srcObject = rs; });
    }

    function toggleTrack(type) {
        const track = type === 'video' ? myStream.getVideoTracks()[0] : myStream.getAudioTracks()[0];
        track.enabled = !track.enabled;
        document.getElementById(type === 'video' ? 'v-btn' : 'm-btn').classList.toggle('active', !track.enabled);
    }

    function endCall() {
        if(currentCall) currentCall.close();
        document.getElementById('call-ui').style.display = 'none';
        // –ù–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å—ë, –∞ –ø—Ä–æ—Å—Ç–æ —á–∏—Å—Ç–∏–º –≤–∏–¥–µ–æ
        document.getElementById('remoteV').srcObject = null;
    }

    // –õ–û–ì–ò–ö–ê –ü–ï–†–ï–ú–ï–©–ï–ù–ò–Ø –û–ö–ù–ê
    const localCont = document.getElementById('local-container');
    let isDragging = false, offset = [0,0];

    localCont.onmousedown = (e) => { isDragging = true; offset = [localCont.offsetLeft - e.clientX, localCont.offsetTop - e.clientY]; };
    document.onmousemove = (e) => { if(isDragging) { localCont.style.left = (e.clientX + offset[0]) + 'px'; localCont.style.top = (e.clientY + offset[1]) + 'px'; } };
    document.onmouseup = () => { isDragging = false; };
    
    // –î–ª—è –º–æ–±–∏–ª–æ–∫
    localCont.ontouchstart = (e) => { isDragging = true; let t = e.touches[0]; offset = [localCont.offsetLeft - t.clientX, localCont.offsetTop - t.clientY]; };
    localCont.ontouchmove = (e) => { if(isDragging) { let t = e.touches[0]; localCont.style.left = (t.clientX + offset[0]) + 'px'; localCont.style.top = (t.clientY + offset[1]) + 'px'; } };

    function handleData(id, data) { addMsgUI(chats[id] || id, data, 'in', id); }
    function addMsgUI(u, t, type, id) {
        const m = document.createElement('div'); m.className = 'msg ' + type; m.innerText = t;
        const c = document.getElementById('messages'); c.appendChild(m); c.scrollTop = c.scrollHeight;
        localStorage.setItem('eh_'+id, c.innerHTML);
    }
    function renderList() {
        const l = document.getElementById('chat-list'); l.innerHTML = '';
        for(let id in chats) {
            const d = document.createElement('div'); d.className = 'chat-item'; d.onclick = () => openChat(id);
            d.innerHTML = `<b>${chats[id]}</b><br><small>ID: ${id}</small>`; l.appendChild(d);
        }
    }
    function openChat(id) { targetId = id; document.getElementById('chat-title').innerText = chats[id]; document.getElementById('messages').innerHTML = localStorage.getItem('eh_'+id) || ''; switchScreen('chat-screen'); conn = peer.connect(id); }
    function switchScreen(s) { document.querySelectorAll('.screen').forEach(x=>x.classList.remove('active')); document.getElementById(s).classList.add('active'); }
    function showAdd(s) { document.getElementById('add-modal').style.display = s ? 'flex' : 'none'; }
    function addFriend() { const id = document.getElementById('f-id').value, n = document.getElementById('f-name').value; if(id && n) { chats[id] = n; localStorage.setItem('fc_v13_chats', JSON.stringify(chats)); renderList(); showAdd(false); } }
    function goBack() { switchScreen('list-screen'); }
</script>
</body>
</html>
