<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CyberGram v8</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root { --bg: #05070a; --panel: #11141b; --accent: #0088cc; --text: #e0e0e0; --danger: #ff4444; --success: #44ff44; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; height: 100vh; overflow: hidden; }
        
        .screen { position: fixed; inset: 0; display: none; flex-direction: column; background: var(--bg); z-index: 10; }
        header { padding: 15px 20px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #1f232d; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        
        /* –í—Ö–æ–¥ */
        #login-screen { display: flex; align-items: center; justify-content: center; z-index: 100; background: radial-gradient(circle at center, #111b27 0%, #05070a 100%); }
        .login-box { background: var(--panel); padding: 30px; border-radius: 24px; border: 1px solid #2a2f3d; width: 90%; max-width: 340px; text-align: center; }
        
        /* –°–ø–∏—Å–∫–∏ */
        .content { flex: 1; overflow-y: auto; padding: 15px; }
        .card { background: var(--panel); padding: 16px; border-radius: 18px; margin-bottom: 12px; display: flex; align-items: center; border: 1px solid #1f232d; transition: 0.2s; }
        .card:active { transform: scale(0.98); background: #1a1f29; }
        .avatar { width: 48px; height: 48px; background: linear-gradient(135deg, var(--accent), #0055aa); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-weight: bold; color: white; font-size: 18px; }

        /* –ß–∞—Ç */
        .messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; background: #080a0f; }
        .msg { max-width: 75%; padding: 10px 16px; border-radius: 18px; font-size: 15px; line-height: 1.4; position: relative; }
        .msg.me { align-self: flex-end; background: var(--accent); color: white; border-bottom-right-radius: 4px; }
        .msg.them { align-self: flex-start; background: var(--panel); border: 1px solid #1f232d; border-bottom-left-radius: 4px; }
        
        /* –ö–Ω–æ–ø–∫–∏ –∏ –ò–Ω–ø—É—Ç—ã */
        .btn { padding: 12px 20px; border-radius: 12px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; }
        .btn-blue { background: var(--accent); color: white; }
        .btn-red { background: var(--danger); color: white; }
        .btn-green { background: var(--success); color: black; }
        
        input { width: 100%; background: #000; border: 1px solid #2a2f3d; color: white; padding: 14px; border-radius: 12px; margin-bottom: 12px; outline: none; font-size: 16px; }
        input:focus { border-color: var(--accent); }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ (–≤–º–µ—Å—Ç–æ prompt) */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-body { background: var(--panel); padding: 25px; border-radius: 24px; width: 100%; max-width: 320px; border: 1px solid #2a2f3d; }

        /* –í–∏–¥–µ–æ */
        #call-ui { position: fixed; inset: 0; background: #000; z-index: 2000; display: none; flex-direction: column; }
        #remote-v { flex: 1; width: 100%; object-fit: cover; }
        #local-v { position: absolute; top: 40px; right: 20px; width: 100px; aspect-ratio: 3/4; border-radius: 16px; border: 2px solid var(--accent); object-fit: cover; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .call-tools { position: absolute; bottom: 50px; width: 100%; display: flex; justify-content: center; gap: 30px; }
    </style>
</head>
<body>

<div id="login-screen" class="screen">
    <div class="login-box">
        <h1 style="color:var(--accent); margin-top:0;">CyberGram</h1>
        <input type="number" id="my-id-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à ID">
        <input type="password" id="my-pw-input" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn btn-blue" style="width:100%" onclick="saveAuth()">–í–û–ô–¢–ò –í –°–ò–°–¢–ï–ú–£</button>
    </div>
</div>

<div id="app-screen" class="screen">
    <header>
        <b>ID: <span id="display-id">0000</span></b>
        <span onclick="logout()" style="color:var(--danger); font-weight:bold; cursor:pointer">–í–´–•–û–î</span>
    </header>
    <div class="content" id="contact-list"></div>
    <button class="btn btn-blue" style="position:fixed; bottom:30px; right:30px; border-radius:50%; width:64px; height:64px; font-size:32px; box-shadow: 0 8px 20px rgba(0,136,204,0.4);" onclick="openModal('add')">+</button>
</div>

<div id="chat-screen" class="screen">
    <header>
        <span onclick="closeChat()" style="font-size:24px; cursor:pointer">‚Üê</span>
        <b id="chat-user-name">–ß–∞—Ç</b>
        <span onclick="startCall()" style="font-size:22px; cursor:pointer">üìû</span>
    </header>
    <div id="decision-bar" style="display:none; padding:10px; background:#1a212c; gap:10px; justify-content:center; border-bottom:1px solid #333;">
        <button class="btn btn-green" onclick="openModal('accept')">–î–û–ë–ê–í–ò–¢–¨</button>
        <button class="btn btn-red" onclick="banStranger()">–í –ë–ê–ù</button>
    </div>
    <div class="messages" id="chat-msgs"></div>
    <div style="padding:15px; background:var(--panel); display:flex; gap:10px; border-top: 1px solid #1f232d;">
        <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0;">
        <button class="btn btn-blue" onclick="sendMsg()">‚ûú</button>
    </div>
</div>

<div id="modal-ui" class="modal">
    <div class="modal-body">
        <h3 id="modal-title" style="margin-top:0">–ö–æ–Ω—Ç–∞–∫—Ç</h3>
        <input type="text" id="modal-name" placeholder="–ò–º—è">
        <input type="number" id="modal-id" placeholder="ID">
        <div style="display:flex; gap:10px;">
            <button class="btn" style="flex:1; background:#333; color:white;" onclick="closeModal()">–û–¢–ú–ï–ù–ê</button>
            <button class="btn btn-blue" style="flex:1" onclick="handleModalSave()">–û–ö</button>
        </div>
    </div>
</div>

<div id="call-ui">
    <video id="remote-v" autoplay playsinline></video>
    <video id="local-v" autoplay playsinline muted></video>
    <div class="call-tools">
        <button id="ans-btn" class="btn btn-green" style="display:none; width:75px; height:75px; border-radius:50%; font-size:24px;" onclick="answerCall()">‚úî</button>
        <button class="btn btn-red" style="width:75px; height:75px; border-radius:50%; font-size:24px;" onclick="location.reload()">üõë</button>
    </div>
</div>

<script>
    let myID, activePeer, mqttClient, pc, localStream, modalMode;
    let friends = JSON.parse(localStorage.getItem('cg_f8') || '[]');
    let bans = JSON.parse(localStorage.getItem('cg_b8') || '[]');
    let logs = {};

    // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    if(localStorage.getItem('cg_id')) {
        myID = localStorage.getItem('cg_id');
        startApp();
    } else { document.getElementById('login-screen').style.display = 'flex'; }

    function saveAuth() {
        const id = document.getElementById('my-id-input').value;
        const pw = document.getElementById('my-pw-input').value;
        if(id && pw) {
            localStorage.setItem('cg_id', id);
            localStorage.setItem('cg_pw', pw);
            location.reload();
        }
    }

    function logout() { localStorage.clear(); location.reload(); }

    function startApp() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-screen').style.display = 'flex';
        document.getElementById('display-id').innerText = myID;
        initMQTT();
        renderList();
    }

    function initMQTT() {
        mqttClient = mqtt.connect('wss://broker.emqx.io:8084/mqtt');
        mqttClient.on('connect', () => mqttClient.subscribe(`cg/v8/${myID}`));
        mqttClient.on('message', async (t, m) => {
            const d = JSON.parse(m.toString());
            if(bans.includes(d.from)) return;

            if(d.type === 'msg') {
                if(!logs[d.from]) logs[d.from] = [];
                logs[d.from].push({side:'them', val:d.val});
                if(activePeer === d.from) renderMsgs();
                renderList();
            } else if(d.type === 'offer') {
                activePeer = d.from; window.offer = d.val;
                document.getElementById('call-ui').style.display = 'flex';
                document.getElementById('ans-btn').style.display = 'block';
            } else if(d.type === 'answer') {
                await pc.setRemoteDescription(new RTCSessionDescription(d.val));
            } else if(d.type === 'ice') {
                if(pc && d.val) await pc.addIceCandidate(new RTCIceCandidate(d.val));
            }
        });
    }

    // –ú–æ–¥–∞–ª–∫–∏
    function openModal(mode) {
        modalMode = mode;
        document.getElementById('modal-ui').style.display = 'flex';
        if(mode === 'accept') {
            document.getElementById('modal-title').innerText = "–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç";
            document.getElementById('modal-id').value = activePeer;
            document.getElementById('modal-id').disabled = true;
        } else {
            document.getElementById('modal-title').innerText = "–ù–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç";
            document.getElementById('modal-id').value = "";
            document.getElementById('modal-id').disabled = false;
        }
    }
    function closeModal() { document.getElementById('modal-ui').style.display = 'none'; }

    function handleModalSave() {
        const name = document.getElementById('modal-name').value;
        const id = document.getElementById('modal-id').value;
        if(name && id) {
            friends = friends.filter(f => f.id !== id.toString());
            friends.push({id: id.toString(), name: name});
            localStorage.setItem('cg_f8', JSON.stringify(friends));
            renderList();
            closeModal();
            if(modalMode === 'accept') document.getElementById('decision-bar').style.display = 'none';
        }
    }

    // –°–ø–∏—Å–æ–∫ –∏ –ß–∞—Ç
    function renderList() {
        const container = document.getElementById('contact-list');
        container.innerHTML = "";
        friends.forEach(f => {
            const d = document.createElement('div');
            d.className = 'card';
            d.onclick = () => openChat(f.id, f.name);
            d.innerHTML = `<div class="avatar">${f.name[0]}</div><div><b>${f.name}</b><br><small style="opacity:0.5">ID: ${f.id}</small></div>`;
            container.appendChild(d);
        });
        Object.keys(logs).forEach(id => {
            if(!friends.find(f => f.id === id) && !bans.includes(id)) {
                const d = document.createElement('div');
                d.className = 'card';
                d.style.borderColor = var(--accent);
                d.onclick = () => openChat(id, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π");
                d.innerHTML = `<div class="avatar" style="background:#444">?</div><div><b>–ù–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç</b><br><small>ID: ${id}</small></div>`;
                container.appendChild(d);
            }
        });
    }

    function openChat(id, name) {
        activePeer = id;
        document.getElementById('chat-user-name').innerText = name;
        document.getElementById('chat-screen').style.display = 'flex';
        document.getElementById('decision-bar').style.display = friends.find(f => f.id === id) ? 'none' : 'flex';
        renderMsgs();
    }

    function closeChat() { document.getElementById('chat-screen').style.display = 'none'; }

    function sendMsg() {
        const i = document.getElementById('msg-input');
        if(!i.value) return;
        mqttClient.publish(`cg/v8/${activePeer}`, JSON.stringify({type:'msg', from:myID, val:i.value}));
        if(!logs[activePeer]) logs[activePeer] = [];
        logs[activePeer].push({side:'me', val:i.value});
        i.value = ""; renderMsgs();
    }

    function renderMsgs() {
        const b = document.getElementById('chat-msgs');
        b.innerHTML = "";
        (logs[activePeer] || []).forEach(m => {
            const d = document.createElement('div');
            d.className = `msg ${m.side}`; d.innerText = m.val;
            b.appendChild(d);
        });
        b.scrollTop = b.scrollHeight;
    }

    function banStranger() {
        bans.push(activePeer);
        localStorage.setItem('cg_b8', JSON.stringify(bans));
        closeChat(); renderList();
    }

    // –ó–≤–æ–Ω–∫–∏
    async function startCall() {
        document.getElementById('call-ui').style.display = 'flex';
        localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
        document.getElementById('local-v').srcObject = localStream;
        pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        pc.onicecandidate = e => e.candidate && mqttClient.publish(`cg/v8/${activePeer}`, JSON.stringify({type:'ice', from:myID, val:e.candidate}));
        pc.ontrack = e => document.getElementById('remote-v').srcObject = e.streams[0];
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        mqttClient.publish(`cg/v8/${activePeer}`, JSON.stringify({type:'offer', from:myID, val:offer}));
    }

    async function answerCall() {
        document.getElementById('ans-btn').style.display = 'none';
        localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
        document.getElementById('local-v').srcObject = localStream;
        pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        pc.onicecandidate = e => e.candidate && mqttClient.publish(`cg/v8/${activePeer}`, JSON.stringify({type:'ice', from:myID, val:e.candidate}));
        pc.ontrack = e => document.getElementById('remote-v').srcObject = e.streams[0];
        await pc.setRemoteDescription(new RTCSessionDescription(window.offer));
        const ans = await pc.createAnswer();
        await pc.setLocalDescription(ans);
        mqttClient.publish(`cg/v8/${activePeer}`, JSON.stringify({type:'answer', from:myID, val:ans}));
    }
</script>
</body>
</html>
