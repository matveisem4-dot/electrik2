<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FearConnect v1.1</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: #fff; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #auth-box { margin: auto; background: #1e1e1e; padding: 25px; border-radius: 12px; text-align: center; border: 1px solid #333; width: 300px; }
        input { padding: 10px; margin: 5px; border-radius: 6px; border: 1px solid #444; background: #252525; color: #fff; width: 80%; }
        button { padding: 10px 15px; border-radius: 6px; border: none; background: #ff4444; color: #fff; cursor: pointer; font-weight: bold; margin: 5px; }
        button:active { background: #cc0000; }
        
        #main-box { display: none; flex-direction: column; height: 100%; }
        .vids { display: flex; background: #000; justify-content: center; min-height: 200px; }
        video { width: 50%; max-width: 400px; background: #222; border: 1px solid #333; }
        
        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; background: #181818; }
        .m { background: #333; padding: 8px 12px; border-radius: 8px; width: fit-content; max-width: 80%; word-break: break-all; }
        .my { background: #ff4444; align-self: flex-end; }
        
        .bar { background: #1e1e1e; padding: 15px; display: flex; gap: 10px; align-items: center; }
        #typing { color: #ff4444; font-size: 12px; padding-left: 15px; height: 15px; background: #181818; }
    </style>
</head>
<body>

    <div id="auth-box">
        <h1>FEAR CONNECT</h1>
        <input type="text" id="loginInput" placeholder="–¢–≤–æ–π ID"> <br>
        <input type="password" id="passInput" placeholder="–ü–∞—Ä–æ–ª—å"> <br>
        <button onclick="handleAuth(true)">–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</button>
        <button onclick="handleAuth(false)">–í–•–û–î</button>
    </div>

    <div id="main-box">
        <div class="vids">
            <video id="localV" autoplay muted playsinline></video>
            <video id="remoteV" autoplay playsinline></video>
        </div>
        <div id="typing"></div>
        <div id="chat"></div>
        <div class="bar">
            <input type="text" id="targetID" placeholder="–ö–û–ú–£ (ID)" style="width:80px">
            <input type="text" id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1" oninput="doTyping()">
            <button onclick="sendMsg()">–û–¢–ü–†–ê–í–ò–¢–¨</button>
            <button onclick="makeCall()">–ó–í–û–ù–û–ö üìû</button>
        </div>
    </div>

    <script>
        console.log("FearConnect Engine starting...");
        
        let protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        let ws = new WebSocket(protocol + window.location.host);
        
        let myID = '';
        let pc = null;
        let localStream = null;
        let tTimer = null;

        const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        ws.onopen = () => console.log("‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
        ws.onerror = (err) => console.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∫–µ—Ç–∞:", err);

        ws.onmessage = async (e) => {
            const d = JSON.parse(e.data);
            console.log("–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:", d.type);

            if (d.type === 'auth_ok') {
                myID = d.login;
                document.getElementById('auth-box').style.display = 'none';
                document.getElementById('main-box').style.display = 'flex';
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                    document.getElementById('localV').srcObject = localStream;
                } catch (err) {
                    console.error("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:", err);
                    alert("–í–∫–ª—é—á–∏ –∫–∞–º–µ—Ä—É!");
                }
            }

            if (d.type === 'error') alert(d.msg);

            if (d.type === 'new_msg') {
                let m = document.createElement('div');
                m.className = 'm' + (d.from === myID ? ' my' : '');
                m.innerHTML = `<b>${d.from}:</b> ${d.text}`;
                const chat = document.getElementById('chat');
                chat.appendChild(m);
                chat.scrollTop = chat.scrollHeight;
            }

            if (d.type === 'typing') document.getElementById('typing').innerText = d.from + ' –ø–µ—á–∞—Ç–∞–µ—Ç...';
            if (d.type === 'stop_typing') document.getElementById('typing').innerText = '';

            // –í–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏
            if (d.type === 'offer') {
                if (confirm("–ó–≤–æ–Ω–∏—Ç " + d.from + ". –û—Ç–≤–µ—Ç–∏—Ç—å?")) {
                    initPeer(d.from);
                    await pc.setRemoteDescription(new RTCSessionDescription(d.offer));
                    let a = await pc.createAnswer();
                    await pc.setLocalDescription(a);
                    ws.send(JSON.stringify({type: 'answer', to: d.from, answer: a}));
                }
            }
            if (d.type === 'answer') await pc.setRemoteDescription(new RTCSessionDescription(d.answer));
            if (d.type === 'candidate') await pc.addIceCandidate(new RTCIceCandidate(d.candidate));
        };

        function handleAuth(isReg) {
            const login = document.getElementById('loginInput').value;
            const pass = document.getElementById('passInput').value;
            if (!login || !pass) return alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è!");
            ws.send(JSON.stringify({type: 'auth', login, pass, isReg}));
        }

        function sendMsg() {
            const text = document.getElementById('msgInput').value;
            const to = document.getElementById('targetID').value;
            if (!text || !to) return alert("–í–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç –∏ ID –¥—Ä—É–≥–∞!");
            ws.send(JSON.stringify({type: 'msg', to: to, text: text}));
            document.getElementById('msgInput').value = '';
        }

        function doTyping() {
            const to = document.getElementById('targetID').value;
            if (!to) return;
            ws.send(JSON.stringify({type: 'typing', to: to}));
            clearTimeout(tTimer);
            tTimer = setTimeout(() => ws.send(JSON.stringify({type: 'stop_typing', to: to})), 2000);
        }

        async function makeCall() {
            const to = document.getElementById('targetID').value;
            if (!to) return alert("–ö–æ–º—É –∑–≤–æ–Ω–∏—Ç—å? –í–≤–µ–¥–∏ ID!");
            initPeer(to);
            let o = await pc.createOffer();
            await pc.setLocalDescription(o);
            ws.send(JSON.stringify({type: 'offer', to: to, offer: o}));
        }

        function initPeer(tID) {
            pc = new RTCPeerConnection(config);
            if (localStream) {
                localStream.getTracks().forEach(tr => pc.addTrack(tr, localStream));
            }
            pc.onicecandidate = (e) => {
                if (e.candidate) ws.send(JSON.stringify({type: 'candidate', to: tID, candidate: e.candidate}));
            };
            pc.ontrack = (e) => {
                document.getElementById('remoteV').srcObject = e.streams[0];
            };
        }
    </script>
</body>
</html>
