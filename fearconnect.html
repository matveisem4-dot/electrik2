<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FearConnect Messenger</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #0b141a; --side: #111b21; --chat-bg: #0b141a; --panel: #202c33; --accent: #ff4444; --text: #e9edef; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }
        
        /* –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ */
        #login-screen { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box { background: var(--panel); padding: 30px; border-radius: 20px; text-align: center; width: 300px; box-shadow: 0 10px 50px rgba(0,0,0,0.5); }
        input { background: #2a3942; border: none; padding: 12px; color: #fff; border-radius: 8px; width: 90%; margin-bottom: 15px; outline: none; }
        button { background: var(--accent); border: none; padding: 12px 20px; color: #fff; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        .app-container { display: flex; height: 100vh; width: 100vw; }
        
        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
        .sidebar { width: 300px; background: var(--side); border-right: 1px solid #333; display: flex; flex-direction: column; }
        .sidebar-header { padding: 15px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; }
        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item { padding: 15px; border-bottom: 1px solid #222; cursor: pointer; display: flex; flex-direction: column; }
        .chat-item:hover { background: #202c33; }
        .chat-item b { color: var(--accent); }

        /* –û—Å–Ω–æ–≤–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ */
        .chat-window { flex: 1; display: flex; flex-direction: column; position: relative; }
        .chat-header { padding: 10px 20px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; }
        
        .video-container { position: absolute; top: 70px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 100; }
        video { width: 150px; border-radius: 10px; background: #000; border: 2px solid var(--accent); box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        #remoteV { width: 300px; }

        #messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }
        .msg { padding: 8px 15px; border-radius: 10px; max-width: 70%; word-wrap: break-word; }
        .msg.in { background: var(--panel); align-self: flex-start; }
        .msg.out { background: #005c4b; align-self: flex-end; }

        .input-area { padding: 15px; background: var(--panel); display: flex; gap: 10px; }

        /* –ú–æ–¥–∞–ª–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
        #settings-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 id="lang-welcome">FearConnect</h2>
            <input type="text" id="my-id-inp" placeholder="–í–∞—à ID">
            <button onclick="login()" id="lang-login-btn">–í–æ–π—Ç–∏</button>
        </div>
    </div>

    <div id="settings-modal">
        <div class="login-box">
            <h3 id="lang-settings-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <select id="lang-select" onchange="changeLang()" style="width: 100%; padding: 10px; border-radius: 5px; background: #2a3942; color: #fff;">
                <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                <option value="en">English</option>
            </select>
            <br><br>
            <button onclick="closeSettings()">OK</button>
        </div>
    </div>

    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <span id="user-name-display"></span>
                <button onclick="openSettings()" style="width: auto; padding: 5px;">‚öôÔ∏è</button>
            </div>
            <div style="padding: 10px;">
                <input type="text" id="new-friend-id" placeholder="ID –¥—Ä—É–≥–∞" style="width: 80%; margin: 0;">
                <input type="text" id="new-friend-name" placeholder="–ò–º—è" style="width: 80%; margin: 5px 0;">
                <button onclick="addChat()" style="font-size: 12px;">+ –î–æ–±–∞–≤–∏—Ç—å —á–∞—Ç</button>
            </div>
            <div class="chat-list" id="chat-list"></div>
        </div>

        <div class="chat-window">
            <div class="chat-header">
                <h3 id="current-chat-name">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                <div>
                    <button onclick="startCall()" style="width: auto; background: #28a745;">üìû –ó–≤–æ–Ω–æ–∫</button>
                </div>
            </div>

            <div class="video-container">
                <video id="localV" autoplay muted playsinline></video>
                <video id="remoteV" autoplay playsinline></video>
            </div>

            <div id="messages"></div>

            <div class="input-area">
                <input type="text" id="msg-inp" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin: 0;">
                <button onclick="sendMsg()" style="width: auto;">‚û§</button>
            </div>
        </div>
    </div>

    <script>
        let peer, conn, localStream, currentTargetId;
        let chats = JSON.parse(localStorage.getItem('fear_chats') || '{}');
        let config = JSON.parse(localStorage.getItem('fear_config') || '{"lang":"ru"}');

        const i18n = {
            ru: { welcome: "–í—Ö–æ–¥", login: "–í–æ–π—Ç–∏", settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏", select_chat: "–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç", call: "–ó–≤–æ–Ω–æ–∫", friend_id: "ID –¥—Ä—É–≥–∞", name: "–ò–º—è" },
            en: { welcome: "Login", login: "Login", settings: "Settings", select_chat: "Select chat", call: "Call", friend_id: "Friend ID", name: "Name" }
        };

        function updateLang() {
            const l = i18n[config.lang];
            document.getElementById('lang-welcome').innerText = l.welcome;
            document.getElementById('lang-login-btn').innerText = l.login;
            document.getElementById('lang-settings-title').innerText = l.settings;
            document.getElementById('current-chat-name').innerText = l.select_chat;
            document.getElementById('new-friend-id').placeholder = l.friend_id;
            document.getElementById('new-friend-name').placeholder = l.name;
        }

        async function login() {
            const myID = document.getElementById('my-id-inp').value;
            if (!myID) return;
            peer = new Peer(myID);
            peer.on('open', (id) => {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('user-name-display').innerText = id;
                initMedia();
                renderChats();
                updateLang();
            });
            peer.on('connection', c => {
                conn = c;
                currentTargetId = c.peer;
                setupConn();
            });
            peer.on('call', call => {
                if(confirm("–ó–≤–æ–Ω–æ–∫ –æ—Ç " + (chats[call.peer] || call.peer))) {
                    call.answer(localStream);
                    call.on('stream', s => document.getElementById('remoteV').srcObject = s);
                }
            });
        }

        async function initMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                document.getElementById('localV').srcObject = localStream;
            } catch(e) { console.error("–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"); }
        }

        function addChat() {
            const id = document.getElementById('new-friend-id').value;
            const name = document.getElementById('new-friend-name').value;
            if(!id || !name) return;
            chats[id] = name;
            localStorage.setItem('fear_chats', JSON.stringify(chats));
            renderChats();
        }

        function renderChats() {
            const list = document.getElementById('chat-list');
            list.innerHTML = '';
            for (let id in chats) {
                const item = document.createElement('div');
                item.className = 'chat-item';
                item.innerHTML = `<b>${chats[id]}</b><small>${id}</small>`;
                item.onclick = () => selectChat(id);
                list.appendChild(item);
            }
        }

        function selectChat(id) {
            currentTargetId = id;
            document.getElementById('current-chat-name').innerText = chats[id];
            document.getElementById('messages').innerHTML = localStorage.getItem('hist_' + id) || '';
            conn = peer.connect(id);
            setupConn();
        }

        function setupConn() {
            conn.on('data', data => addMsg(chats[conn.peer] || conn.peer, data, 'in'));
        }

        function sendMsg() {
            const text = document.getElementById('msg-inp').value;
            if(!text || !currentTargetId) return;
            if(conn && conn.open) {
                conn.send(text);
                addMsg('–Ø', text, 'out');
                document.getElementById('msg-inp').value = '';
            }
        }

        function addMsg(user, text, type) {
            const m = document.createElement('div');
            m.className = `msg ${type}`;
            m.innerHTML = `<small>${user}</small><br>${text}`;
            const box = document.getElementById('messages');
            box.appendChild(m);
            box.scrollTop = box.scrollHeight;
            localStorage.setItem('hist_' + currentTargetId, box.innerHTML);
        }

        function startCall() {
            const call = peer.call(currentTargetId, localStream);
            call.on('stream', s => document.getElementById('remoteV').srcObject = s);
        }

        function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
        function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
        
        function changeLang() {
            config.lang = document.getElementById('lang-select').value;
            localStorage.setItem('fear_config', JSON.stringify(config));
            updateLang();
        }

        updateLang();
    </script>
</body>
</html>
