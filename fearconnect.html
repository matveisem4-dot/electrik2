<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root { --bg: #07090e; --panel: #11141a; --accent: #00f2ff; --text: #e1e8ef; --danger: #ff3333; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* TOAST */
        #toast { position: fixed; top: 50px; left: 50%; transform: translateX(-50%); background: var(--accent); color: #000; padding: 12px 30px; border-radius: 25px; font-weight: bold; z-index: 10000; display: none; box-shadow: 0 0 20px rgba(0,242,255,0.4); }

        /* TITLEBAR */
        .title-bar { height: 32px; background: #000; display: flex; justify-content: space-between; align-items: center; -webkit-app-region: drag; border-bottom: 1px solid #111; }
        .win-controls { -webkit-app-region: no-drag; display: flex; }
        .win-btn { width: 45px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .win-btn:hover { background: #333; }

        /* SCREENS */
        .screen { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .active { display: flex; }
        .card { background: var(--panel); padding: 30px; border-radius: 24px; width: 90%; max-width: 380px; text-align: center; border: 1px solid #ffffff05; }
        
        input { width: 100%; padding: 14px; margin: 10px 0; background: #000; border: 1px solid #333; color: #fff; border-radius: 12px; outline: none; }
        .btn { width: 100%; padding: 14px; background: var(--accent); color: #000; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-secondary { background: #222; color: #fff; border: 1px solid #333; }

        /* MAIN */
        .app-main { display: flex; flex: 1; height: calc(100vh - 32px); }
        .sidebar { width: 280px; background: var(--panel); border-right: 1px solid #000; display: flex; flex-direction: column; }
        .chat-area { flex: 1; display: flex; flex-direction: column; background: #090c10; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        
        .contact-item { padding: 15px; border-bottom: 1px solid #111; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .contact-item:hover { background: #1a1f26; }
        
        /* MODALS */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: var(--panel); padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; border: 1px solid #333; }
    </style>
</head>
<body>

    <div id="toast"></div>

    <div class="title-bar" id="drag-bar">
        <div style="padding-left:15px; font-size:10px; color:var(--accent); font-weight:bold;">FEAR CONNECT</div>
        <div class="win-controls">
            <div class="win-btn" onclick="winAction('win-minimize')">Ôºç</div>
            <div class="win-btn" onclick="winAction('win-close')">‚úï</div>
        </div>
    </div>

    <div id="screen-auth" class="screen active">
        <div class="card">
            <h2 id="auth-t">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <input type="text" id="in-id" placeholder="–í–∞—à ID">
            <input type="password" id="in-ps" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn" onclick="handleAuth()">–î–ê–õ–ï–ï</button>
            <p onclick="toggleLogin()" style="cursor:pointer; margin-top:15px; color:var(--accent); font-size:12px;">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç?</p>
        </div>
    </div>

    <div id="screen-lang" class="screen">
        <div class="card">
            <h2>–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫</h2>
            <button class="btn btn-secondary" onclick="setLang('RU')">–†—É—Å—Å–∫–∏–π</button>
            <button class="btn btn-secondary" onclick="setLang('EN')">English</button>
        </div>
    </div>

    <div id="screen-phone" class="screen">
        <div class="card">
            <h2>–í–∞—à –Ω–æ–º–µ—Ä</h2>
            <input type="text" id="in-phone" placeholder="+7 900 000 00 00">
            <button class="btn" onclick="savePhone()">–°–û–•–†–ê–ù–ò–¢–¨</button>
            <button class="btn btn-secondary" onclick="nextScreen('app')">–ü–†–û–ü–£–°–¢–ò–¢–¨</button>
        </div>
    </div>

    <div class="app-main">
        <div class="sidebar">
            <div style="padding:15px; display:flex; gap:10px;">
                <button class="btn" style="flex:1" onclick="openM('add-m')">Ôºã –ß–ê–¢</button>
                <button class="btn" style="width:50px" onclick="openM('set-m')">‚öôÔ∏è</button>
            </div>
            <div id="contact-list" style="flex:1; overflow-y:auto;"></div>
            <div id="my-info" style="padding:10px; font-size:10px; text-align:center; background:#000;">ID: ---</div>
        </div>
        <div class="chat-area">
            <div id="chat-header" style="padding:15px; background:var(--panel); border-bottom:1px solid #000; display:none; justify-content:space-between; align-items:center;">
                <b id="active-user-name">–ß–∞—Ç</b>
                <button class="btn" id="call-btn" style="width:auto; padding:5px 15px; margin:0; background:#28a745; color:white;">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
            </div>
            <div id="messages"></div>
            <div id="input-area" style="padding:15px; display:none; gap:10px; background:var(--panel);">
                <input type="text" id="m-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0">
                <button class="btn" style="width:60px; margin:0" onclick="sendMsg()">‚û§</button>
            </div>
        </div>
    </div>

    <div id="set-m" class="modal">
        <div class="modal-content">
            <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h3>
            <div style="margin:15px 0;">
                <label style="font-size:12px; color:#666;">–í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</label>
                <input type="text" id="set-phone-val" placeholder="–ù–µ —É–∫–∞–∑–∞–Ω">
                <button class="btn" onclick="updateProfile()">–û–ë–ù–û–í–ò–¢–¨</button>
            </div>
            <button class="btn btn-secondary" onclick="closeM('set-m')">–ó–ê–ö–†–´–¢–¨</button>
        </div>
    </div>

    <div id="add-m" class="modal">
        <div class="modal-content">
            <h3>–ù–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç</h3>
            <input type="text" id="target-id" placeholder="ID –¥—Ä—É–≥–∞">
            <input type="text" id="target-phone" placeholder="–ù–æ–º–µ—Ä (–µ—Å–ª–∏ –µ—Å—Ç—å)">
            <button class="btn" onclick="addContact()">–î–û–ë–ê–í–ò–¢–¨</button>
            <button class="btn btn-secondary" onclick="closeM('add-m')">–û–¢–ú–ï–ù–ê</button>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
        let peer, activeChatId, activeChatPhone, isLogin = false;

        function showToast(t) {
            const el = document.getElementById('toast');
            el.innerText = t; el.style.display='block';
            setTimeout(()=> el.style.display='none', 2500);
        }

        function nextScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            if(id !== 'app') document.getElementById('screen-'+id).classList.add('active');
        }

        function toggleLogin() {
            isLogin = !isLogin;
            document.getElementById('auth-t').innerText = isLogin ? "–í—Ö–æ–¥" : "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è";
        }

        function handleAuth() {
            const id = document.getElementById('in-id').value;
            const ps = document.getElementById('in-ps').value;
            if(!id || !ps) return showToast("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è!");

            if(!isLogin) {
                localStorage.setItem('f_id', id);
                localStorage.setItem('f_ps', ps);
                nextScreen('lang');
            } else {
                if(id === localStorage.getItem('f_id') && ps === localStorage.getItem('f_ps')) {
                    startPeer(id);
                    nextScreen('app');
                } else showToast("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞!");
            }
        }

        function savePhone() {
            localStorage.setItem('f_phone', document.getElementById('in-phone').value);
            nextScreen('app');
            startPeer(localStorage.getItem('f_id'));
        }

        function startPeer(id) {
            peer = new Peer(id);
            document.getElementById('my-info').innerText = "ONLINE: " + id;
            document.getElementById('set-phone-val').value = localStorage.getItem('f_phone') || "";
            peer.on('connection', c => {
                c.on('data', d => { if(activeChatId === c.peer) render(d, 'msg-in'); });
            });
        }

        function addContact() {
            const id = document.getElementById('target-id').value;
            const phone = document.getElementById('target-phone').value;
            if(!id) return;
            const list = document.getElementById('contact-list');
            list.innerHTML += `<div class="contact-item" onclick="selectChat('${id}', '${phone}')">
                <span>üë§ ${id}</span>
                <small style="color:#444">${phone}</small>
            </div>`;
            closeM('add-m');
        }

        function selectChat(id, phone) {
            activeChatId = id; activeChatPhone = phone;
            document.getElementById('chat-header').style.display = 'flex';
            document.getElementById('input-area').style.display = 'flex';
            document.getElementById('active-user-name').innerText = id;
            document.getElementById('messages').innerHTML = "";
            
            // –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –µ—Å—Ç—å, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–≤–æ–Ω–∫–∞
            const cBtn = document.getElementById('call-btn');
            if(phone && phone.trim() !== "") {
                cBtn.style.display = 'block';
                cBtn.onclick = () => window.open(`tel:${phone}`);
            } else {
                cBtn.style.display = 'none';
            }
        }

        function sendMsg() {
            const m = document.getElementById('m-input').value;
            if(!activeChatId || !m) return;
            const c = peer.connect(activeChatId);
            c.on('open', () => {
                c.send(m); render(m, 'msg-out');
                document.getElementById('m-input').value = "";
            });
        }

        function render(t, s) {
            const b = document.getElementById('messages');
            b.innerHTML += `<div style="padding:10px; border-radius:10px; margin:5px; max-width:70%; background:${s==='msg-out'?'#004d5e':'#1a1f26'}; align-self:${s==='msg-out'?'flex-end':'flex-start'}">${t}</div>`;
            b.scrollTop = b.scrollHeight;
        }

        function updateProfile() {
            localStorage.setItem('f_phone', document.getElementById('set-phone-val').value);
            showToast("–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!");
            closeM('set-m');
        }

        function openM(id) { document.getElementById(id).style.display = 'flex'; }
        function closeM(id) { document.getElementById(id).style.display = 'none'; }
        
        function winAction(act) {
            try { require('electron').ipcRenderer.send(act); } catch(e) {}
        }
    </script>
</body>
</html>
