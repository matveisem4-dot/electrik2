<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FearConnect P2P Pro</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --main-color: #ff4444; --bg: #0b141a; --panel: #202c33; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #fff; margin: 0; overflow: hidden; height: 100vh; }
        
        /* –°—Ç–∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤—Ö–æ–¥–∞ */
        #login-screen { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .login-card { background: var(--panel); padding: 30px; border-radius: 20px; width: 300px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã */
        #custom-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; }
        .modal-box { background: var(--panel); padding: 20px; border-radius: 15px; width: 280px; text-align: center; border: 1px solid var(--main-color); }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        #main-app { display: none; flex-direction: column; height: 100vh; }
        .header { background: var(--panel); padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        .video-container { display: flex; background: #000; height: 180px; gap: 5px; padding: 5px; }
        video { flex: 1; background: #111; border-radius: 10px; object-fit: cover; border: 1px solid #333; }
        
        #chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 75%; font-size: 15px; line-height: 1.4; }
        .in { background: var(--panel); align-self: flex-start; border-bottom-left-radius: 2px; }
        .out { background: #005c4b; align-self: flex-end; border-bottom-right-radius: 2px; }

        input, button { padding: 12px; border-radius: 10px; border: none; outline: none; }
        input { background: #2a3942; color: #fff; width: 80%; margin-bottom: 10px; }
        button { background: var(--main-color); color: #fff; font-weight: bold; cursor: pointer; }
        button:active { transform: scale(0.95); }
        
        .google-btn { background: #fff; color: #000; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; }
        
        .bottom-bar { background: var(--panel); padding: 15px; display: flex; gap: 10px; }
    </style>
</head>
<body>

    <div id="custom-modal">
        <div class="modal-box">
            <h3 id="modal-title">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h3>
            <p id="modal-text"></p>
            <div id="modal-buttons" style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="closeModal()">OK</button>
            </div>
        </div>
    </div>

    <div id="login-screen">
        <div class="login-card">
            <h1 style="color: var(--main-color); margin-bottom: 5px;">FearConnect</h1>
            <p style="font-size: 12px; opacity: 0.6;">–ü—Ä–∏–¥—É–º–∞–π —Å–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID</p>
            <input type="text" id="my-id-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: fear-master">
            <button onclick="startApp()" style="width: 100%;">–í–û–ô–¢–ò –ü–û ID</button>
            <button class="google-btn" onclick="showModal('Google Login', '–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –¥–ª—è –ï–≥–∏–ø—Ç–∞! üá™üá¨')">
                <img src="https://www.gstatic.com/images/branding/product/1x/gsa_512dp.png" width="18"> Google
            </button>
        </div>
    </div>

    <div id="main-app">
        <div class="header">
            <div style="font-size: 14px;">–ü—Ä–∏–≤–µ—Ç, <b id="display-id" style="color:var(--main-color)"></b></div>
            <button onclick="location.reload()" style="padding: 5px 10px; font-size: 10px; background: #444;">–í–´–•–û–î</button>
        </div>

        <div class="video-container">
            <video id="localV" autoplay muted playsinline></video>
            <video id="remoteV" autoplay playsinline></video>
        </div>

        <div id="chat"></div>

        <div class="bottom-bar">
            <input type="text" id="target-id" placeholder="ID –¥—Ä—É–≥–∞" style="width: 80px; margin: 0;">
            <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin: 0;">
            <button onclick="sendMessage()">‚û§</button>
            <button onclick="makeCall()" style="background: #28a745;">üìû</button>
        </div>
    </div>

    <script>
        let peer, conn, localStream;
        const chatDiv = document.getElementById('chat');

        // –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê
        function showModal(title, text, confirmCallback = null) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-text').innerText = text;
            const btnBox = document.getElementById('modal-buttons');
            btnBox.innerHTML = '';
            
            if (confirmCallback) {
                const yesBtn = document.createElement('button');
                yesBtn.innerText = "–î–ê";
                yesBtn.onclick = () => { confirmCallback(); closeModal(); };
                const noBtn = document.createElement('button');
                noBtn.innerText = "–ù–ï–¢";
                noBtn.style.background = "#555";
                noBtn.onclick = closeModal;
                btnBox.append(yesBtn, noBtn);
            } else {
                const okBtn = document.createElement('button');
                okBtn.innerText = "–ü–û–ù–Ø–õ";
                okBtn.onclick = closeModal;
                btnBox.append(okBtn);
            }
            document.getElementById('custom-modal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('custom-modal').style.display = 'none'; }

        // –õ–û–ì–ò–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        async function startApp() {
            const myID = document.getElementById('my-id-input').value;
            if (!myID) return showModal('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏ —Å–≤–æ–π ID!');

            peer = new Peer(myID); // –¢–≤–æ–π –∫–∞—Å—Ç–æ–º–Ω—ã–π ID!

            peer.on('open', () => {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
                document.getElementById('display-id').innerText = myID;
                loadHistory();
                initCamera();
            });

            peer.on('error', (err) => {
                if(err.type === 'unavailable-id') showModal('–£–ø—Å!', '–≠—Ç–æ—Ç ID —É–∂–µ –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.');
                else showModal('–û—à–∏–±–∫–∞', '–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫...');
            });

            peer.on('connection', c => { conn = c; setupConn(); });
            peer.on('call', call => {
                showModal('–í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤', '–¢–µ–±–µ –∑–≤–æ–Ω–∏—Ç ' + call.peer, () => {
                    call.answer(localStream);
                    call.on('stream', s => document.getElementById('remoteV').srcObject = s);
                });
            });
        }

        async function initCamera() {
            localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
            document.getElementById('localV').srcObject = localStream;
        }

        function setupConn() {
            conn.on('data', data => addMessage('–î—Ä—É–≥', data, 'in'));
            conn.on('open', () => addMessage('–°–∏—Å—Ç–µ–º–∞', '–°–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!', 'in'));
        }

        function sendMessage() {
            const text = document.getElementById('msg-input').value;
            const target = document.getElementById('target-id').value;
            if (!text || !target) return;

            if (!conn || conn.peer !== target) {
                conn = peer.connect(target);
                setupConn();
                setTimeout(sendMessage, 500);
            } else {
                conn.send(text);
                addMessage('–Ø', text, 'out');
                document.getElementById('msg-input').value = '';
            }
        }

        async function makeCall() {
            const target = document.getElementById('target-id').value;
            const call = peer.call(target, localStream);
            call.on('stream', s => document.getElementById('remoteV').srcObject = s);
        }

        function addMessage(user, text, type) {
            const m = document.createElement('div');
            m.className = `msg ${type}`;
            m.innerHTML = `<small style="opacity:0.5">${user}</small><br>${text}`;
            chatDiv.appendChild(m);
            chatDiv.scrollTop = chatDiv.scrollHeight;
            localStorage.setItem('fear_chat_' + document.getElementById('display-id').innerText, chatDiv.innerHTML);
        }

        function loadHistory() {
            const hist = localStorage.getItem('fear_chat_' + document.getElementById('display-id').innerText);
            if (hist) chatDiv.innerHTML = hist;
        }
    </script>
</body>
</html>
