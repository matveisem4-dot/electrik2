<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FearConnect Pro</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #0a0a0c; --accent: #ff3b30; --panel: #1c1c1e; --text: #ffffff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; margin: 0; padding: 0; }
        body { font-family: -apple-system, system-ui; background: var(--bg); color: var(--text); overflow: hidden; height: 100vh; }
        
        /* UI –≠–ª–µ–º–µ–Ω—Ç—ã */
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; background: var(--bg); }
        .active { display: flex; }
        .btn { padding: 15px; background: var(--accent); border: none; color: #fff; border-radius: 14px; font-weight: bold; cursor: pointer; }
        .btn:active { opacity: 0.7; }
        input { background: #1c1c1e; border: 1px solid #333; padding: 16px; color: #fff; border-radius: 14px; font-size: 16px; margin-bottom: 10px; }

        /* –ö–∞—Å—Ç–æ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–í–º–µ—Å—Ç–æ –∞–ª–µ—Ä—Ç–æ–≤) */
        #custom-alert { position: fixed; top: 20px; left: 20px; right: 20px; background: var(--panel); border: 1px solid var(--accent); padding: 20px; border-radius: 20px; z-index: 9999; display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }

        /* –®–∞–ø–∫–∞ */
        .header { padding: 50px 20px 15px; background: rgba(28,28,30,0.9); backdrop-filter: blur(20px); border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }

        /* –ó–≤–æ–Ω–æ–∫ */
        #call-screen { background: #000; z-index: 5000; }
        #remoteV { width: 100%; height: 100%; object-fit: cover; }
        #local-container { position: absolute; top: 60px; right: 20px; width: 110px; height: 160px; border-radius: 15px; overflow: hidden; border: 2px solid var(--accent); z-index: 5001; }
        .call-tools { position: absolute; bottom: 40px; left: 0; right: 0; display: flex; justify-content: center; gap: 20px; }
        
        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
        #settings-panel { position: absolute; bottom: 0; left: 0; right: 0; background: var(--panel); padding: 30px; border-radius: 30px 30px 0 0; transform: translateY(100%); transition: 0.3s; z-index: 6000; }
        #settings-panel.open { transform: translateY(0); }
    </style>
</head>
<body>

    <div id="custom-alert">
        <p id="alert-text" style="margin-bottom:15px; font-weight:bold;"></p>
        <div style="display:flex; gap:10px;">
            <button class="btn" id="alert-ok" style="flex:1">OK</button>
            <button class="btn" id="alert-cancel" style="flex:1; background:#444">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div id="login-screen" class="screen active" style="justify-content:center; padding:30px;">
        <h1 style="font-size:40px; text-align:center; color:var(--accent);">FearConnect</h1>
        <p style="text-align:center; opacity:0.5; margin-bottom:30px;">Anonymous P2P Network</p>
        
        <input type="text" id="my-id" placeholder="ID –∏–ª–∏ –ò–º—è">
        <input type="password" id="my-pass" placeholder="–ü–∞—Ä–æ–ª—å">
        
        <div style="font-size:11px; opacity:0.4; margin: 10px 0 20px; line-height:1.2;">
            –ù–∞–∂–∏–º–∞—è "–í–û–ô–¢–ò", –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å, —á—Ç–æ –¥–∞–Ω–Ω–æ–µ –ü–û –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è "–∫–∞–∫ –µ—Å—Ç—å". –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ –Ω–µ—Å–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –∫–æ–Ω—Ç–µ–Ω—Ç, –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, –∏ –Ω–µ —Ö—Ä–∞–Ω–∏—Ç –Ω–∏–∫–∞–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö. –í—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–∞ —Å–≤–æ–π —Å—Ç—Ä–∞—Ö –∏ —Ä–∏—Å–∫.
        </div>
        <button class="btn" onclick="initApp()">–ü–†–ò–ù–Ø–¢–¨ –ò –í–û–ô–¢–ò</button>
    </div>

    <div id="list-screen" class="screen">
        <div class="header">
            <h2 id="txt-chats">–ß–∞—Ç—ã</h2>
            <div onclick="toggleSettings(true)" style="font-size:24px;">‚öôÔ∏è</div>
        </div>
        <div id="chat-list" style="flex:1; overflow-y:auto; padding:10px;"></div>
        <div style="padding:20px; background:var(--panel); border-radius:25px 25px 0 0; display:flex; gap:10px;">
            <input type="text" id="f-id" placeholder="ID –∏–ª–∏ –ù–æ–º–µ—Ä" style="margin:0; flex:1">
            <button class="btn" onclick="addFriend()">+</button>
        </div>
    </div>

    <div id="chat-screen" class="screen">
        <div class="header">
            <button onclick="goBack()" style="background:none; border:none; color:var(--accent); font-size:20px;">‚¨Ö</button>
            <b id="chat-title">...</b>
            <button onclick="makeCall()" style="background:none; border:none; font-size:24px;">üìû</button>
        </div>
        <div id="messages" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:10px;"></div>
        <div style="padding:15px 15px 35px; background:var(--panel); display:flex; gap:10px;">
            <input type="text" id="msg-input" style="flex:1; border-radius:20px; margin:0;" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
            <button onclick="sendMsg()" class="btn" style="border-radius:50%; width:50px; height:50px; padding:0;">‚û§</button>
        </div>
    </div>

    <div id="call-screen" class="screen">
        <video id="remoteV" autoplay playsinline></video>
        <div id="local-container">
            <video id="localV" autoplay muted playsinline></video>
        </div>
        <div class="call-tools">
            <button class="btn" style="background:#444; width:60px; height:60px; border-radius:50%;" onclick="toggleMute()">üé§</button>
            <button class="btn" style="width:120px; border-radius:30px;" onclick="endCall(true)">–°–ë–†–û–°</button>
        </div>
    </div>

    <div id="settings-panel">
        <h3 style="margin-bottom:20px;">Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
        <p style="opacity:0.5; font-size:12px;">–í–∞—à –Ω–æ–º–µ—Ä: <b id="my-num-display" style="color:var(--accent)"></b></p>
        <div style="margin:20px 0; display:flex; gap:10px;">
            <button class="btn" style="flex:1; background:#333" onclick="setLang('ru')">–†—É—Å—Å–∫–∏–π</button>
            <button class="btn" style="flex:1; background:#333" onclick="setLang('en')">English</button>
        </div>
        <button class="btn" style="width:100%; background:#444" onclick="toggleSettings(false)">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

<script>
    let peer, conn, targetId, myStream, currentCall, myNum;
    let chats = JSON.parse(localStorage.getItem('fc_v14_chats') || '{}');
    let lang = localStorage.getItem('fc_lang') || 'ru';

    // –°–ò–°–¢–ï–ú–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô
    function uiAlert(text, showCancel, onOk) {
        const modal = document.getElementById('custom-alert');
        const okBtn = document.getElementById('alert-ok');
        const cancelBtn = document.getElementById('alert-cancel');
        document.getElementById('alert-text').innerText = text;
        modal.style.display = 'block';
        cancelBtn.style.display = showCancel ? 'block' : 'none';
        okBtn.onclick = () => { modal.style.display = 'none'; if(onOk) onOk(); };
        cancelBtn.onclick = () => { modal.style.display = 'none'; };
    }

    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    function initApp() {
        const id = document.getElementById('my-id').value.trim();
        const pass = document.getElementById('my-pass').value.trim();
        if(!id || !pass) return uiAlert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ!");

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ "–Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞"
        myNum = localStorage.getItem('num_'+id) || Math.floor(Math.random() * 89999999999 + 70000000000).toString();
        localStorage.setItem('num_'+id, myNum);
        document.getElementById('my-num-display').innerText = "+" + myNum;

        peer = new Peer(id, { 
            config: { 'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }, { 'urls': 'stun:stun.services.mozilla.com' }] } 
        });

        peer.on('open', () => {
            switchScreen('list-screen');
            renderList();
            setupMedia();
        });

        peer.on('connection', c => {
            conn = c;
            c.on('data', d => {
                if(d === 'BYE') endCall(false);
                else handleData(c.peer, d);
            });
        });

        peer.on('call', call => {
            uiAlert("–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç " + call.peer, true, () => {
                currentCall = call;
                call.answer(myStream);
                document.getElementById('call-screen').classList.add('active');
                call.on('stream', rs => document.getElementById('remoteV').srcObject = rs);
            });
        });

        peer.on('error', (err) => {
            if(err.type === 'unavailable-id') uiAlert("–≠—Ç–æ—Ç –Ω–∏–∫ —É–∂–µ –∑–∞–Ω—è—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π.");
        });
    }

    async function setupMedia() {
        try { myStream = await navigator.mediaDevices.getUserMedia({video:true, audio: {echoCancellation: true}}); 
        document.getElementById('localV').srcObject = myStream; } catch(e) {}
    }

    // –õ–û–ì–ò–ö–ê –°–û–û–ë–©–ï–ù–ò–ô
    function sendMsg() {
        const i = document.getElementById('msg-input');
        if(!i.value) return;
        const val = i.value;

        const attempt = () => {
            if(conn && conn.open) {
                conn.send(val);
                addMsgUI('–í—ã', val, 'out', targetId);
                i.value = '';
            } else {
                conn = peer.connect(targetId);
                conn.on('open', () => { conn.send(val); addMsgUI('–í—ã', val, 'out', targetId); i.value = ''; });
            }
        };
        attempt();
    }

    function handleData(id, data) { addMsgUI(chats[id] || id, data, 'in', id); }

    function addMsgUI(u, t, type, id) {
        const m = document.createElement('div');
        m.style.padding = '12px 16px'; m.style.borderRadius = '18px';
        m.style.maxWidth = '80%'; m.style.alignSelf = type === 'out' ? 'flex-end' : 'flex-start';
        m.style.background = type === 'out' ? var(--accent) : '#222';
        m.style.background = type === 'out' ? '#ff3b30' : '#2c2c2e';
        m.innerText = t;
        const box = document.getElementById('messages');
        box.appendChild(m); box.scrollTop = box.scrollHeight;
        localStorage.setItem('msglog_'+id, box.innerHTML);
    }

    // –ó–í–û–ù–ö–ò
    function makeCall() {
        document.getElementById('call-screen').classList.add('active');
        currentCall = peer.call(targetId, myStream);
        currentCall.on('stream', rs => document.getElementById('remoteV').srcObject = rs);
    }

    function endCall(notify) {
        if(notify && conn) conn.send('BYE');
        if(currentCall) currentCall.close();
        document.getElementById('call-screen').classList.remove('active');
        document.getElementById('remoteV').srcObject = null;
    }

    function toggleMute() {
        const t = myStream.getAudioTracks()[0];
        t.enabled = !t.enabled;
    }

    // –ò–ù–¢–ï–†–§–ï–ô–°
    function renderList() {
        const l = document.getElementById('chat-list'); l.innerHTML = '';
        for(let id in chats) {
            const d = document.createElement('div');
            d.style.padding = '20px'; d.style.borderBottom = '1px solid #222';
            d.innerHTML = `<b>${chats[id]}</b><br><small style="opacity:0.3">ID: ${id}</small>`;
            d.onclick = () => {
                targetId = id;
                document.getElementById('chat-title').innerText = chats[id];
                document.getElementById('messages').innerHTML = localStorage.getItem('msglog_'+id) || '';
                switchScreen('chat-screen');
                conn = peer.connect(id);
            };
            l.appendChild(d);
        }
    }

    function addFriend() {
        const id = document.getElementById('f-id').value.trim();
        if(id) {
            chats[id] = "User_" + id.substring(0,4);
            localStorage.setItem('fc_v14_chats', JSON.stringify(chats));
            renderList();
            document.getElementById('f-id').value = '';
        }
    }

    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function goBack() { switchScreen('list-screen'); }
    function toggleSettings(open) { document.getElementById('settings-panel').classList.toggle('open', open); }
    
    function setLang(l) {
        lang = l; localStorage.setItem('fc_lang', l);
        document.getElementById('txt-chats').innerText = l === 'ru' ? '–ß–∞—Ç—ã' : 'Chats';
        toggleSettings(false);
    }
</script>
</body>
</html>
