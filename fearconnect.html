<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FearConnect</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: #fff; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #auth-box { margin: auto; background: #1e1e1e; padding: 25px; border-radius: 12px; text-align: center; border: 1px solid #333; }
        input { padding: 10px; margin: 5px; border-radius: 6px; border: 1px solid #444; background: #252525; color: #fff; }
        button { padding: 10px 15px; border-radius: 6px; border: none; background: #ff4444; color: #fff; cursor: pointer; font-weight: bold; }
        
        #main-box { display: none; flex-direction: column; height: 100%; }
        .vids { display: flex; background: #000; justify-content: center; }
        video { width: 50%; max-width: 400px; height: auto; background: #222; }
        
        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .m { background: #333; padding: 8px 12px; border-radius: 8px; width: fit-content; max-width: 80%; }
        .my { background: #ff4444; align-self: flex-end; }
        
        .bar { background: #1e1e1e; padding: 15px; display: flex; gap: 10px; }
        #typing { color: #ff4444; font-size: 12px; padding-left: 15px; height: 15px; }
    </style>
</head>
<body>

    <div id="auth-box">
        <h1>FEAR CONNECT</h1>
        <input type="text" id="login" placeholder="ID"> <br>
        <input type="password" id="pass" placeholder="Password"> <br>
        <button onclick="auth(true)">REG</button>
        <button onclick="auth(false)">LOGIN</button>
    </div>

    <div id="main-box">
        <div class="vids">
            <video id="localV" autoplay muted playsinline></video>
            <video id="remoteV" autoplay playsinline></video>
        </div>
        <div id="chat"></div>
        <div id="typing"></div>
        <div class="bar">
            <input type="text" id="target" placeholder="TO ID" style="width:70px">
            <input type="text" id="msg" placeholder="Message..." style="flex:1" oninput="doTyping()">
            <button onclick="send()">SEND</button>
            <button onclick="call()">CALL ðŸ“ž</button>
        </div>
    </div>

    <script>
        let protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        let ws = new WebSocket(protocol + window.location.host);
        let myID, pc, stream, tTimer;

        ws.onmessage = async (e) => {
            const d = JSON.parse(e.data);
            if (d.type === 'auth_ok') {
                myID = d.login;
                document.getElementById('auth-box').style.display='none';
                document.getElementById('main-box').style.display='flex';
                stream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
                document.getElementById('localV').srcObject = stream;
            }
            if (d.type === 'new_msg') {
                let m = document.createElement('div');
                m.className = 'm' + (d.from === myID ? ' my' : '');
                m.innerHTML = `<b>${d.from}:</b> ${d.text}`;
                document.getElementById('chat').appendChild(m);
                document.getElementById('chat').scrollTop = 99999;
            }
            if (d.type === 'typing') document.getElementById('typing').innerText = d.from + ' typing...';
            if (d.type === 'stop_typing') document.getElementById('typing').innerText = '';

            // Calling Logic
            if (d.type === 'offer') {
                if(confirm("Call from " + d.from)) {
                    initPeer(d.from);
                    await pc.setRemoteDescription(new RTCSessionDescription(d.offer));
                    let a = await pc.createAnswer();
                    await pc.setLocalDescription(a);
                    ws.send(JSON.stringify({type:'answer', to:d.from, answer:a}));
                }
            }
            if (d.type === 'answer') await pc.setRemoteDescription(new RTCSessionDescription(d.answer));
            if (d.type === 'candidate') await pc.addIceCandidate(new RTCIceCandidate(d.candidate));
        };

        function auth(reg) { ws.send(JSON.stringify({type:'auth', login:login.value, pass:pass.value, isReg:reg})); }
        
        function send() { 
            ws.send(JSON.stringify({type:'msg', to:target.value, text:msg.value})); 
            msg.value = ''; 
        }

        function doTyping() {
            ws.send(JSON.stringify({type:'typing', to:target.value}));
            clearTimeout(tTimer);
            tTimer = setTimeout(()=> ws.send(JSON.stringify({type:'stop_typing', to:target.value})), 2000);
        }

        async function call() {
            initPeer(target.value);
            let o = await pc.createOffer();
            await pc.setLocalDescription(o);
            ws.send(JSON.stringify({type:'offer', to:target.value, offer:o}));
        }

        function initPeer(tID) {
            pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
            stream.getTracks().forEach(tr => pc.addTrack(tr, stream));
            pc.onicecandidate = (e) => e.candidate && ws.send(JSON.stringify({type:'candidate', to:tID, candidate:e.candidate}));
            pc.ontrack = (e) => document.getElementById('remoteV').srcObject = e.streams[0];
        }
    </script>
</body>
</html>
