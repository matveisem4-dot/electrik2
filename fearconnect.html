<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CyberGram P2P</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root { --tg-bg: #0e1621; --tg-light-bg: #17212b; --tg-blue: #2481cc; --tg-text: #f5f5f5; --success: #31b545; --danger: #e53935; }
        body, html { margin: 0; padding: 0; background: var(--tg-bg); color: var(--tg-text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; height: 100vh; overflow: hidden; }
        
        /* –≠–∫—Ä–∞–Ω –ø–∞—Ä–æ–ª—è */
        #lock-screen { position: fixed; inset: 0; background: var(--tg-bg); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .input-code { background: var(--tg-light-bg); border: 1px solid var(--tg-blue); color: white; padding: 15px; border-radius: 12px; width: 200px; text-align: center; font-size: 20px; letter-spacing: 5px; }

        /* –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ */
        #app-interface { display: none; flex-direction: column; height: 100vh; }
        header { background: var(--tg-light-bg); padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #111; }
        .contact-list { flex: 1; overflow-y: auto; padding: 10px; }
        .contact-item { background: var(--tg-light-bg); padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: 0.2s; }
        .contact-item:active { transform: scale(0.98); background: #202b36; }
        .avatar { width: 45px; height: 45px; background: var(--tg-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; }

        /* –ó–≤–æ–Ω–æ–∫ */
        #video-chat { display: none; position: fixed; inset: 0; background: black; z-index: 5000; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { position: absolute; top: 20px; right: 20px; width: 100px; aspect-ratio: 3/4; border-radius: 10px; border: 2px solid var(--tg-blue); object-fit: cover; transform: scaleX(-1); }
        .speaking { outline: 6px solid var(--success); outline-offset: -6px; }

        /* –í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤ */
        #call-overlay { position: fixed; inset: 0; background: radial-gradient(circle, #1c2a3d, #0e1621); display: none; flex-direction: column; align-items: center; justify-content: space-around; z-index: 6000; }
        .ring-btn { width: 75px; height: 75px; border-radius: 50%; border: none; color: white; font-size: 30px; cursor: pointer; }

        /* –ú–æ–¥–∞–ª–∫–∏ */
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--tg-blue); border-radius: 50%; border: none; color: white; font-size: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
    </style>
</head>
<body>

    <div id="lock-screen">
        <h2 style="color: var(--tg-blue)">CyberGram</h2>
        <input type="password" id="pass-input" class="input-code" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        <button class="btn" onclick="checkPass()" style="background: none; border: none; color: var(--tg-blue); margin-top: 20px; font-weight: bold;">–í–û–ô–¢–ò</button>
    </div>

    <div id="app-interface">
        <header>
            <div><b>CyberGram</b></div>
            <div id="status" style="font-size: 12px; color: var(--danger)">‚óè Offline</div>
        </header>
        
        <div style="padding: 15px; background: var(--tg-light-bg); margin: 10px; border-radius: 10px;">
            <small>–í–∞—à –Ω–æ–º–µ—Ä:</small>
            <div id="my-num" style="font-size: 18px; font-weight: bold; color: var(--tg-blue);">+P2P-0000</div>
        </div>

        <div class="contact-list" id="contacts">
            </div>

        <button class="fab" onclick="addContactPrompt()">+</button>
    </div>

    <div id="call-overlay">
        <div style="text-align: center;">
            <div class="avatar" style="width: 100px; height: 100px; font-size: 40px; margin: 0 auto 20px;">üìû</div>
            <h1 id="caller-name">–í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤</h1>
        </div>
        <div style="display: flex; gap: 50px;">
            <button class="ring-btn" onclick="acceptCall()" style="background: var(--success)">‚úî</button>
            <button class="ring-btn" onclick="rejectCall(true)" style="background: var(--danger)">‚úñ</button>
        </div>
        <audio id="ringtone" loop src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"></audio>
    </div>

    <div id="video-chat">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay muted playsinline></video>
        <div style="position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: center;">
            <button class="ring-btn" style="background: var(--danger)" onclick="rejectCall(true)">üõë</button>
        </div>
    </div>

<script>
    const USER_PASS = "1234";
    const myId = Math.floor(1000 + Math.random() * 9000).toString();
    const myPhone = "+P2P-" + myId;
    
    document.getElementById('my-num').innerText = myPhone;
    let contacts = JSON.parse(localStorage.getItem('contacts') || '[]');
    let client, pc, targetId, localStream;

    function checkPass() {
        if(document.getElementById('pass-input').value === USER_PASS) {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('app-interface').style.display = 'flex';
            renderContacts();
            initMQTT();
        }
    }

    function renderContacts() {
        const container = document.getElementById('contacts');
        container.innerHTML = contacts.length ? '' : '<p style="text-align:center; color:#555">–°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø—É—Å—Ç</p>';
        contacts.forEach(c => {
            const div = document.createElement('div');
            div.className = 'contact-item';
            div.innerHTML = `
                <div style="display:flex; align-items:center">
                    <div class="avatar">${c.name[0]}</div>
                    <div><b>${c.name}</b><br><small style="color:#555">+P2P-${c.id}</small></div>
                </div>
                <button onclick="startCall('${c.id}')" style="background:none; border:none; font-size:20px; color:var(--tg-blue)">üìû</button>
            `;
            container.appendChild(div);
        });
    }

    function addContactPrompt() {
        const name = prompt("–ò–º—è –¥—Ä—É–≥–∞:");
        const id = prompt("ID –¥—Ä—É–≥–∞ (4 —Ü–∏—Ñ—Ä—ã):");
        if(name && id) {
            contacts.push({name, id});
            localStorage.setItem('contacts', JSON.stringify(contacts));
            renderContacts();
        }
    }

    function initMQTT() {
        client = mqtt.connect('wss://broker.emqx.io:8084/mqtt');
        client.on('connect', () => {
            document.getElementById('status').innerText = "‚óè Online";
            document.getElementById('status').style.color = "var(--success)";
            client.subscribe(`p2p/call/${myId}`);
        });
        
        client.on('message', async (topic, msg) => {
            const data = JSON.parse(msg.toString());
            if (data.type === 'offer') {
                targetId = data.from;
                window.pendingOffer = data.offer;
                document.getElementById('caller-name').innerText = "+P2P-" + data.from;
                document.getElementById('call-overlay').style.display = 'flex';
                document.getElementById('ringtone').play();
            } else if (data.type === 'answer') {
                await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
            } else if (data.type === 'ice') {
                if(pc) pc.addIceCandidate(new RTCIceCandidate(data.candidate));
            } else if (data.type === 'hangup') {
                stopAll();
            }
        });
    }

    async function startCall(id) {
        targetId = id;
        await setupMedia(true);
    }

    async function setupMedia(isOffer) {
        const constraints = { video: { facingMode: "user" }, audio: { echoCancellation: true } };
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        document.getElementById('local-video').srcObject = localStream;
        document.getElementById('video-chat').style.display = 'block';

        pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        
        pc.onicecandidate = e => e.candidate && sendSignal({ type: 'ice', candidate: e.candidate });
        pc.ontrack = e => {
            document.getElementById('remote-video').srcObject = e.streams[0];
            detectVolume(e.streams[0]);
        };

        if(isOffer) {
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            sendSignal({ type: 'offer', offer: offer, from: myId });
        }
    }

    async function acceptCall() {
        document.getElementById('ringtone').pause();
        document.getElementById('call-overlay').style.display = 'none';
        await setupMedia(false);
        await pc.setRemoteDescription(new RTCSessionDescription(window.pendingOffer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        sendSignal({ type: 'answer', answer: answer });
    }

    function sendSignal(data) {
        client.publish(`p2p/call/${targetId}`, JSON.stringify(data));
    }

    function rejectCall(notify) {
        if(notify && targetId) sendSignal({ type: 'hangup' });
        stopAll();
    }

    function stopAll() {
        if(localStream) localStream.getTracks().forEach(t => t.stop());
        location.reload(); 
    }

    function detectVolume(stream) {
        const ctx = new AudioContext();
        const src = ctx.createMediaStreamSource(stream);
        const ans = ctx.createAnalyser();
        src.connect(ans);
        const data = new Uint8Array(ans.frequencyBinCount);
        function loop() {
            ans.getByteFrequencyData(data);
            let avg = data.reduce((a,b)=>a+b)/data.length;
            const rv = document.getElementById('remote-video');
            if(avg > 35) rv.classList.add('speaking');
            else rv.classList.remove('speaking');
            requestAnimationFrame(loop);
        }
        loop();
    }
</script>
</body>
</html>
