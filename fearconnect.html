<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>FearConnect Pro</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #0b141a; --panel: #202c33; --accent: #ff4444; --text: #e9edef; --msg-out: #005c4b; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body, html { 
            margin: 0; padding: 0; height: 100%; 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg); color: var(--text); 
            overflow: hidden; width: 100%;
        }

        .screen { 
            position: absolute; inset: 0; 
            background: var(--bg); display: none; flex-direction: column; 
            transition: 0.3s ease;
        }
        .screen.active { display: flex; }

        /* –í—Ö–æ–¥ */
        #login-screen { display: flex; align-items: center; justify-content: center; z-index: 100; }
        .box { background: var(--panel); padding: 30px; border-radius: 25px; width: 90%; max-width: 340px; text-align: center; }

        .header { padding: 10px 15px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; height: 60px; border-bottom: 1px solid #333; }
        
        /* –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ */
        #chat-list { flex: 1; overflow-y: auto; }
        .chat-item { padding: 15px; border-bottom: 1px solid #1c262d; display: flex; align-items: center; gap: 15px; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        #messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #080e12; }
        .msg { padding: 10px 14px; border-radius: 16px; max-width: 80%; font-size: 15px; word-wrap: break-word; }
        .msg.in { background: var(--panel); align-self: flex-start; }
        .msg.out { background: var(--msg-out); align-self: flex-end; }

        input { background: #2a3942; border: none; padding: 14px; color: #fff; border-radius: 12px; width: 100%; font-size: 16px; margin-bottom: 10px; }
        .fab { position: fixed; bottom: 30px; right: 25px; width: 56px; height: 56px; background: var(--accent); border-radius: 50%; border: none; color: #fff; font-size: 28px; z-index: 50; }

        /* –ó–≤–æ–Ω–æ–∫ */
        #call-ui { position: fixed; inset: 0; background: #000; z-index: 500; display: none; flex-direction: column; }
        video { width: 100%; height: 50%; object-fit: cover; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen active">
        <div class="box">
            <h1 style="color:var(--accent); margin:0">FearConnect</h1>
            <p style="opacity:0.5; margin-bottom:20px">–í–≤–µ–¥–∏ –Ω–∏–∫ –∏ –ø–∞—Ä–æ–ª—å</p>
            <input type="text" id="my-id" placeholder="–¢–≤–æ–π ID (–ù–∏–∫)">
            <input type="password" id="my-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="initApp()" style="width:100%; padding:15px; background:var(--accent); border:none; color:#fff; border-radius:12px; font-weight:bold;">–í–û–ô–¢–ò</button>
        </div>
    </div>

    <div id="list-screen" class="screen">
        <div class="header"><b>–ß–∞—Ç—ã</b><small id="id-tag" style="opacity:0.4"></small></div>
        <div id="chat-list"></div>
        <button class="fab" onclick="showAdd(true)">+</button>
    </div>

    <div id="chat-screen" class="screen">
        <div class="header">
            <button onclick="goBack()" style="background:none; border:none; color:var(--accent); font-size:24px;">‚¨Ö</button>
            <b id="chat-title">–ß–∞—Ç</b>
            <button onclick="makeCall()" style="background:none; border:none; font-size:20px">üìû</button>
        </div>
        <div id="messages"></div>
        <div style="padding:10px; background:var(--panel); display:flex; gap:10px;">
            <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0">
            <button onclick="sendMsg()" style="background:var(--accent); border:none; padding:10px 15px; border-radius:10px; color:#fff;">‚û§</button>
        </div>
    </div>

    <div id="add-modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; z-index:1000;">
        <div class="box">
            <h3>–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</h3>
            <input type="text" id="f-id" placeholder="ID –¥—Ä—É–≥–∞">
            <input type="text" id="f-name" placeholder="–ò–º—è">
            <button onclick="addFriend()" style="width:100%; padding:12px; background:var(--accent); border:none; color:#fff; border-radius:10px;">–û–ö</button>
            <button onclick="showAdd(false)" style="background:none; border:none; color:#777; margin-top:10px">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div id="call-ui">
        <video id="remoteV" autoplay playsinline></video>
        <video id="localV" autoplay muted playsinline style="height:25%; border-top:2px solid var(--accent)"></video>
        <button onclick="location.reload()" style="padding:20px; background:red; color:white; border:none; font-weight:bold;">–ó–ê–í–ï–†–®–ò–¢–¨</button>
    </div>

<script>
    let peer, conn, stream, targetId;
    let chats = JSON.parse(localStorage.getItem('fc_final_chats') || '{}');

    function initApp() {
        const id = document.getElementById('my-id').value;
        const pass = document.getElementById('my-pass').value;

        if(!id || !pass) return alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è!");

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
        const savedPass = localStorage.getItem('p_' + id);
        if(savedPass && savedPass !== pass) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
        localStorage.setItem('p_' + id, pass);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Peer
        peer = new Peer(id, { config: {'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }]} });

        peer.on('open', () => {
            showScreen('list-screen');
            document.getElementById('id-tag').innerText = " ID: " + id;
            renderList();
            initMedia();
        });

        peer.on('error', err => alert("–û—à–∏–±–∫–∞: " + err.type));

        peer.on('connection', c => {
            c.on('data', d => handleData(c.peer, d));
        });

        peer.on('call', call => {
            if(confirm("–ó–≤–æ–Ω–æ–∫! –û—Ç–≤–µ—Ç–∏—Ç—å?")) {
                call.answer(stream);
                document.getElementById('call-ui').style.display = 'flex';
                call.on('stream', rs => document.getElementById('remoteV').srcObject = rs);
            }
        });
    }

    async function initMedia() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
            document.getElementById('localV').srcObject = stream;
        } catch(e) { console.warn("–ö–∞–º–µ—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞"); }
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function addFriend() {
        const id = document.getElementById('f-id').value, name = document.getElementById('f-name').value;
        if(id && name) {
            chats[id] = name;
            localStorage.setItem('fc_final_chats', JSON.stringify(chats));
            renderList();
            showAdd(false);
        }
    }

    function renderList() {
        const l = document.getElementById('chat-list'); l.innerHTML = '';
        for(let id in chats) {
            l.innerHTML += `<div class="chat-item" onclick="openChat('${id}')">
                <div class="avatar">${chats[id][0]}</div>
                <div><b>${chats[id]}</b><br><small style="opacity:0.5">${id}</small></div>
            </div>`;
        }
    }

    function openChat(id) {
        targetId = id;
        document.getElementById('chat-title').innerText = chats[id];
        document.getElementById('messages').innerHTML = localStorage.getItem('hist_'+id) || '';
        showScreen('chat-screen');
        conn = peer.connect(id);
        conn.on('data', d => handleData(id, d));
    }

    function sendMsg() {
        const i = document.getElementById('msg-input');
        if(!i.value || !conn) return;
        conn.send(i.value);
        addMsgUI('–Ø', i.value, 'out', targetId);
        i.value = '';
    }

    function handleData(id, data) {
        addMsgUI(chats[id] || id, data, 'in', id);
    }

    function addMsgUI(u, t, type, id) {
        const m = document.createElement('div');
        m.className = 'msg ' + type;
        m.innerHTML = `<small style="font-size:10px;opacity:0.5">${u}</small><br>${t}`;
        document.getElementById('messages').appendChild(m);
        document.getElementById('messages').scrollTop = 99999;
        localStorage.setItem('hist_'+id, document.getElementById('messages').innerHTML);
    }

    function goBack() { showScreen('list-screen'); }
    function showAdd(s) { document.getElementById('add-modal').style.display = s ? 'flex' : 'none'; }
    function makeCall() {
        document.getElementById('call-ui').style.display = 'flex';
        const call = peer.call(targetId, stream);
        call.on('stream', rs => document.getElementById('remoteV').srcObject = rs);
    }
</script>
</body>
</html>
