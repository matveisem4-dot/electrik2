<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CyberGram OS Fix</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root { --bg: #080a0c; --panel: #111418; --accent: #0088cc; --text: #ffffff; --danger: #ff3b30; --success: #4cd964; }
        body, html { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: sans-serif; height: 100vh; overflow: hidden; }
        .screen { position: fixed; inset: 0; display: none; flex-direction: column; background: var(--bg); }
        header { padding: 15px 20px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; }
        .list { flex: 1; overflow-y: auto; padding: 15px; }
        .card { background: var(--panel); padding: 15px; border-radius: 18px; margin-bottom: 10px; display: flex; align-items: center; border: 1px solid #222; }
        .avatar { width: 45px; height: 45px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-weight: bold; }
        .btn { padding: 10px 15px; border-radius: 12px; border: none; cursor: pointer; font-weight: bold; color: white; }
        .btn-accent { background: var(--accent); }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }
        .chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 75%; padding: 10px 14px; border-radius: 16px; font-size: 14px; }
        .msg.me { align-self: flex-end; background: var(--accent); }
        .msg.them { align-self: flex-start; background: var(--panel); }
        
        /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —ç–∫—Ä–∞–Ω –∑–≤–æ–Ω–∫–∞ */
        #call-screen { background: #000; z-index: 20000; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; background: #111; }
        #local-video { position: absolute; top: 20px; right: 20px; width: 100px; aspect-ratio: 3/4; border-radius: 12px; border: 2px solid var(--accent); object-fit: cover; transform: scaleX(-1); z-index: 21; }
        .call-ui { position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: center; gap: 30px; z-index: 22; }
        .btn-round { width: 70px; height: 70px; border-radius: 50%; border: none; color: white; font-size: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        #modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 30000; display: none; align-items: center; justify-content: center; }
        .modal-box { background: var(--panel); padding: 25px; border-radius: 20px; width: 80%; max-width: 300px; text-align: center; border: 1px solid var(--accent); }
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--accent); border-radius: 50%; border: none; color: white; font-size: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<div id="lock-screen" class="screen" style="display: flex;">
    <h1 style="color:var(--accent)">CYBERGRAM</h1>
    <input type="password" id="pin" placeholder="PIN" maxlength="4" style="background:var(--panel); border:1px solid var(--accent); color:white; padding:15px; border-radius:10px; text-align:center; font-size:20px; width:120px;">
    <button onclick="auth()" style="margin-top:20px; background:none; border:none; color:var(--accent); font-weight:bold; cursor:pointer;">CONNECT</button>
</div>

<div id="app" class="screen">
    <header>
        <div><b>ID: <span id="my-id-label">0000</span></b></div>
        <div onclick="location.reload()">üö™</div>
    </header>
    <div class="list" id="contact-list"></div>
    <button class="fab" onclick="showAddModal()">+</button>
</div>

<div id="chat-screen" class="screen">
    <header>
        <button onclick="closeChat()" style="background:none; border:none; color:var(--accent); font-size:24px;">‚Üê</button>
        <b id="chat-title">–ß–∞—Ç</b>
        <button onclick="callContact(activeId)" style="background:none; border:none; font-size:20px;">üìû</button>
    </header>
    <div class="chat-box" id="msg-container"></div>
    <div class="input-area" style="padding:15px; background:var(--panel); display:flex; gap:10px;">
        <input type="text" id="m-inp" placeholder="..." style="flex:1; background:#000; border:1px solid #333; color:white; padding:10px; border-radius:10px;">
        <button onclick="sendMsg()" class="btn btn-accent">‚ûú</button>
    </div>
</div>

<div id="call-screen" class="screen">
    <video id="remote-video" autoplay playsinline></video>
    <video id="local-video" autoplay playsinline muted></video>
    <div class="call-ui">
        <button id="btn-accept" class="btn-round" style="background:var(--success); display:none;" onclick="acceptCall()">‚úî</button>
        <button class="btn-round" style="background:var(--danger);" onclick="hangup(true)">üõë</button>
    </div>
    <audio id="ring" loop src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3"></audio>
</div>

<div id="modal">
    <div class="modal-box">
        <h3>–î–æ–±–∞–≤–∏—Ç—å</h3>
        <input type="text" id="in-name" placeholder="–ò–º—è" style="width:90%; padding:10px; margin-bottom:10px; border-radius:8px;">
        <input type="number" id="in-id" placeholder="ID" style="width:90%; padding:10px; border-radius:8px;">
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="closeModal()" class="btn btn-ghost" style="flex:1; background:#333;">–û—Ç–º–µ–Ω–∞</button>
            <button onclick="saveContact()" class="btn btn-accent" style="flex:1">OK</button>
        </div>
    </div>
</div>

<script>
    const MY_PIN = "1234";
    const myId = Math.floor(1000 + Math.random() * 9000).toString();
    document.getElementById('my-id-label').innerText = myId;

    let friends = JSON.parse(localStorage.getItem('f_v4') || '[]');
    let chatLog = {};
    let activeId, client, pc, localStream;

    function auth() {
        if(document.getElementById('pin').value === MY_PIN) {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            setupMQTT(); renderFriends();
        } else { alert("WRONG PIN"); }
    }

    function setupMQTT() {
        client = mqtt.connect('wss://broker.emqx.io:8084/mqtt');
        client.on('connect', () => client.subscribe(`cyber/v4/${myId}`));
        client.on('message', async (topic, msg) => {
            const data = JSON.parse(msg.toString());
            if(data.type === 'msg') {
                if(!chatLog[data.from]) chatLog[data.from] = [];
                chatLog[data.from].push({side:'them', text:data.text});
                if(activeId === data.from) updateChatUI();
            } else if (data.type === 'offer') {
                activeId = data.from;
                window.incomingOffer = data.offer;
                document.getElementById('call-screen').style.display = 'flex';
                document.getElementById('btn-accept').style.display = 'flex';
                document.getElementById('ring').play();
            } else if (data.type === 'answer') {
                if(pc) await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
            } else if (data.type === 'ice') {
                if(pc) await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
            } else if (data.type === 'hangup') { location.reload(); }
        });
    }

    async function startMedia() {
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏ –≤–∏–¥–µ–æ, –∏ –∞—É–¥–∏–æ
        localStream = await navigator.mediaDevices.getUserMedia({ 
            video: { width: 640, height: 480 }, 
            audio: true 
        });
        document.getElementById('local-video').srcObject = localStream;
        return localStream;
    }

    function createPC() {
        pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–∫–∏ –≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        pc.onicecandidate = e => {
            if(e.candidate) client.publish(`cyber/v4/${activeId}`, JSON.stringify({type:'ice', candidate: e.candidate}));
        };

        pc.ontrack = e => {
            const remoteVid = document.getElementById('remote-video');
            if (remoteVid.srcObject !== e.streams[0]) {
                remoteVid.srcObject = e.streams[0];
            }
        };
    }

    async function callContact(id) {
        activeId = id;
        document.getElementById('call-screen').style.display = 'flex';
        await startMedia();
        createPC();
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        client.publish(`cyber/v4/${activeId}`, JSON.stringify({type:'offer', offer: offer, from: myId}));
    }

    async function acceptCall() {
        document.getElementById('ring').pause();
        document.getElementById('btn-accept').style.display = 'none';
        await startMedia();
        createPC();
        await pc.setRemoteDescription(new RTCSessionDescription(window.incomingOffer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        client.publish(`cyber/v4/${activeId}`, JSON.stringify({type:'answer', answer: answer, from: myId}));
    }

    function hangup(notify) {
        if(notify) client.publish(`cyber/v4/${activeId}`, JSON.stringify({type:'hangup'}));
        location.reload();
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —á–∞—Ç–∞...
    function renderFriends() {
        const list = document.getElementById('contact-list');
        list.innerHTML = "";
        friends.forEach(f => {
            const card = document.createElement('div');
            card.className = 'card';
            card.onclick = () => openChat(f.id, f.name);
            card.innerHTML = `<div class="avatar">${f.name[0]}</div><div style="flex:1"><b>${f.name}</b><br><small>ID: ${f.id}</small></div>`;
            list.appendChild(card);
        });
    }

    function openChat(id, name) {
        activeId = id;
        document.getElementById('chat-title').innerText = name;
        document.getElementById('chat-screen').style.display = 'flex';
        updateChatUI();
    }
    function closeChat() { document.getElementById('chat-screen').style.display = 'none'; }
    function sendMsg() {
        const inp = document.getElementById('m-inp');
        if(!inp.value) return;
        client.publish(`cyber/v4/${activeId}`, JSON.stringify({type:'msg', from:myId, text:inp.value}));
        if(!chatLog[activeId]) chatLog[activeId] = [];
        chatLog[activeId].push({side:'me', text:inp.value});
        inp.value = ""; updateChatUI();
    }
    function updateChatUI() {
        const box = document.getElementById('msg-container');
        box.innerHTML = "";
        (chatLog[activeId] || []).forEach(m => {
            const d = document.createElement('div');
            d.className = `msg ${m.side}`; d.innerText = m.text;
            box.appendChild(d);
        });
        box.scrollTop = box.scrollHeight;
    }
    function showAddModal() { document.getElementById('modal').style.display = 'flex'; }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    function saveContact() {
        const n = document.getElementById('in-name').value;
        const i = document.getElementById('in-id').value;
        if(n && i) {
            friends.push({name: n, id: i.toString()});
            localStorage.setItem('f_v4', JSON.stringify(friends));
            renderFriends(); closeModal();
        }
    }
</script>
</body>
</html>
