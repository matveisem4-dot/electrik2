<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Monolith Messenger | OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #050505; color: #fff; font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; }
        #chat { height: calc(100vh - 160px); overflow-y: auto; padding: 20px; scrollbar-width: none; }
        .bubble { background: #111; border: 1px solid #222; padding: 12px; border-radius: 15px; margin-bottom: 10px; max-width: 75%; position: relative; }
        .user { background: #4f46e5; margin-left: auto; border: none; }
        #video-grid { position: fixed; top: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 100; }
        video { width: 200px; border-radius: 12px; border: 2px solid #4f46e5; background: #000; }
        .call-btn { background: #ef4444; width: 50px; height: 50px; border-radius: 50%; display: flex; items-center justify-center; transition: 0.3s; }
        .call-btn:hover { transform: scale(1.1); }
    </style>
</head>
<body>

    <header class="h-16 border-b border-white/5 flex items-center justify-between px-6 bg-black/50 backdrop-blur">
        <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
            <span class="text-xs font-bold tracking-widest">MONOLITH MESSENGER</span>
        </div>
        <div class="flex gap-4">
            <button onclick="startCall('audio')" class="text-zinc-400 hover:text-white"><i class="fas fa-phone"></i> üìû</button>
            <button onclick="startCall('video')" class="text-zinc-400 hover:text-white"><i class="fas fa-video"></i> üìπ</button>
        </div>
    </header>

    <div id="video-grid">
        <video id="localVideo" autoplay muted playsinline></video>
        <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <div id="chat">
        <div class="bubble text-zinc-500 text-xs">–°–∏—Å—Ç–µ–º–∞: –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ. –í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–µ–∫—Å—Ç, —Ñ–æ—Ç–æ –∏–ª–∏ –∑–≤–æ–Ω–∏—Ç—å.</div>
    </div>

    <div class="p-4 bg-zinc-950 border-t border-white/5 flex gap-3">
        <input type="text" id="msgInput" class="flex-1 bg-zinc-900 rounded-2xl px-6 outline-none focus:ring-1 ring-indigo-500" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
        <button onclick="sendMessage()" class="bg-indigo-600 px-8 rounded-2xl font-bold hover:bg-indigo-500">SEND</button>
    </div>

    <script>
        let localStream;
        let peerConnection;
        const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        // 1. –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –ª–æ–≥–∏–∫–∞
        async function sendMessage() {
            const input = document.getElementById('msgInput');
            const chat = document.getElementById('chat');
            const text = input.value.trim();
            if(!text) return;

            addBubble(text, 'user');
            input.value = "";

            const type = text.toLowerCase().includes("–Ω–∞—Ä–∏—Å—É–π") ? "image" : (text.toLowerCase().includes("–≤–∏–¥–µ–æ") ? "video" : "text");
            
            try {
                const res = await fetch(`/api?prompt=${encodeURIComponent(text)}&type=${type}`);
                if(type === 'text') {
                    const data = await res.text();
                    addBubble(data, 'ai');
                } else {
                    const data = await res.json();
                    const media = type === 'image' ? `<img src="${data.url}" class="rounded-lg mt-2">` : `<video src="${data.url}" controls class="mt-2"></video>`;
                    addBubble(`–†–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:<br>${media}`, 'ai');
                }
            } catch(e) { addBubble("–û—à–∏–±–∫–∞ —è–¥—Ä–∞ Vercel", 'ai'); }
        }

        function addBubble(content, role) {
            const chat = document.getElementById('chat');
            chat.innerHTML += `<div class="bubble ${role === 'user' ? 'user' : ''}">${content}</div>`;
            chat.scrollTop = chat.scrollHeight;
        }

        // 2. –õ–æ–≥–∏–∫–∞ –∑–≤–æ–Ω–∫–æ–≤ (WebRTC)
        async function startCall(mode) {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: mode === 'video', 
                    audio: true 
                });
                document.getElementById('localVideo').srcObject = localStream;
                addBubble(`–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ ${mode === 'video' ? '–∫–∞–º–µ—Ä–µ' : '–º–∏–∫—Ä–æ—Ñ–æ–Ω—É'} —Ä–∞–∑—Ä–µ—à–µ–Ω.`, 'ai');
                
                // –ó–¥–µ—Å—å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–∏–≥–Ω–∞–ª –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                alert("–ó–≤–æ–Ω–æ–∫ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω. –î–ª—è —Ä–∞–±–æ—Ç—ã –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Å–≤—è–∑–∏ –Ω—É–∂–µ–Ω –≤—Ç–æ—Ä–æ–π –∞–∫—Ç–∏–≤–Ω—ã–π ID. –í —Ä–µ–∂–∏–º–µ Demo –≤—ã –≤–∏–¥–∏—Ç–µ —Å–µ–±—è.");
            } catch (e) {
                alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏–∞: " + e.message);
            }
        }

        document.getElementById('msgInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
    </script>
</body>
</html>
