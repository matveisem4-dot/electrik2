<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Monolith Messenger | Calls & AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #050505; color: #e5e7eb; font-family: 'Inter', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #chat { flex: 1; overflow-y: auto; padding: 20px; }
        .bubble { background: #111; border: 1px solid #222; padding: 12px; border-radius: 18px; margin-bottom: 10px; max-width: 80%; }
        .user { background: #4f46e5; margin-left: auto; border: none; }
        .call-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
        video { width: 300px; border-radius: 20px; border: 2px solid #4f46e5; margin: 10px; background: #222; }
    </style>
</head>
<body>

    <div id="callOverlay" class="call-container">
        <div class="flex flex-wrap justify-center">
            <video id="remoteVideo" autoplay playsinline></video>
            <video id="localVideo" autoplay muted playsinline></video>
        </div>
        <button onclick="endCall()" class="mt-10 bg-red-600 p-5 rounded-full hover:bg-red-700 transition">
            <i class="fas fa-phone-slash text-2xl"></i>
        </button>
    </div>

    <header class="p-4 border-b border-white/5 flex justify-between items-center bg-black/50 backdrop-blur">
        <div>
            <h1 class="font-bold text-sm tracking-tighter">MONOLITH OS <span class="text-indigo-500">MESSENGER</span></h1>
            <p id="my-id" class="text-[10px] text-zinc-500">ID: Подключение...</p>
        </div>
        <div class="flex gap-4">
            <input type="text" id="peer-id-input" class="bg-zinc-900 text-xs p-2 rounded border border-zinc-800" placeholder="ID друга">
            <button onclick="makeCall()" class="text-green-500 hover:scale-110 transition"><i class="fas fa-video"></i></button>
        </div>
    </header>

    <div id="chat">
        <div class="bubble text-zinc-500 text-xs italic">Система: Для звонка введите ID друга сверху и нажмите иконку видео.</div>
    </div>

    <div class="p-5 bg-zinc-950 border-t border-white/5 flex gap-3">
        <input type="text" id="msgInput" class="flex-1 bg-zinc-900 rounded-2xl px-5 py-3 outline-none focus:ring-1 ring-indigo-500" placeholder="Текст или 'нарисуй...'">
        <button onclick="sendMsg()" class="bg-indigo-600 px-6 rounded-2xl font-bold"><i class="fas fa-paper-plane"></i></button>
    </div>

    <script>
        // --- 1. ЛОГИКА ИИ ---
        async function sendMsg() {
            const input = document.getElementById('msgInput');
            const val = input.value.trim();
            if(!val) return;
            addMsg(val, 'user');
            input.value = "";

            const type = val.toLowerCase().includes("нарисуй") ? "image" : (val.toLowerCase().includes("видео") ? "video" : "text");
            try {
                const res = await fetch(`/api?prompt=${encodeURIComponent(val)}&type=${type}`);
                if (type === 'text') {
                    const data = await res.text();
                    addMsg(data, 'ai');
                } else {
                    const data = await res.json();
                    const media = type === 'image' ? `<img src="${data.url}">` : `<video src="${data.url}" controls></video>`;
                    addMsg(`Результат генерации:<br>${media}`, 'ai');
                }
            } catch (e) { addMsg("Ошибка связи с сервером.", 'ai'); }
        }

        function addMsg(text, role) {
            const chat = document.getElementById('chat');
            chat.innerHTML += `<div class="bubble ${role === 'user' ? 'user' : ''}">${text}</div>`;
            chat.scrollTop = chat.scrollHeight;
        }

        // --- 2. ЛОГИКА ЗВОНКОВ (WebRTC via PeerJS) ---
        const peer = new Peer(); // Генерирует уникальный ID
        let currentCall;

        peer.on('open', (id) => {
            document.getElementById('my-id').innerText = "ВАШ ID: " + id;
        });

        // Входящий звонок
        peer.on('call', async (call) => {
            if (confirm("Вам звонят! Принять?")) {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('callOverlay').style.display = 'flex';
                document.getElementById('localVideo').srcObject = stream;
                call.answer(stream);
                setupCallHandlers(call);
            }
        });

        async function makeCall() {
            const destId = document.getElementById('peer-id-input').value;
            if(!destId) return alert("Введите ID получателя");

            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('callOverlay').style.display = 'flex';
            document.getElementById('localVideo').srcObject = stream;

            const call = peer.call(destId, stream);
            setupCallHandlers(call);
        }

        function setupCallHandlers(call) {
            currentCall = call;
            call.on('stream', (remoteStream) => {
                document.getElementById('remoteVideo').srcObject = remoteStream;
            });
            call.on('close', endCall);
        }

        function endCall() {
            document.getElementById('callOverlay').style.display = 'none';
            if (currentCall) currentCall.close();
            const localVideo = document.getElementById('localVideo');
            if (localVideo.srcObject) {
                localVideo.srcObject.getTracks().forEach(track => track.stop());
            }
        }

        document.getElementById('msgInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMsg(); });
    </script>
</body>
</html>
