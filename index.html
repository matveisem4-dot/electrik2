<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HEXA Messenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --bg-dark: #0f0f10; --accent: #5865f2; --msg-me: #3b82f6; --msg-peer: #27272a; }
        body { background-color: var(--bg-dark); color: #e4e4e7; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Скроллбар */
        #chat::-webkit-scrollbar { width: 4px; }
        #chat::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }

        /* Сообщения в стиле мессенджера */
        .bubble { max-width: 85%; padding: 8px 14px; border-radius: 18px; font-size: 15px; margin-bottom: 4px; line-height: 1.4; position: relative; }
        .my-msg { background: var(--msg-me); align-self: flex-end; border-bottom-right-radius: 4px; color: white; }
        .peer-msg { background: var(--msg-peer); align-self: flex-start; border-bottom-left-radius: 4px; }
        
        /* Экран звонка */
        .call-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .video-box { position: relative; width: 90%; max-width: 800px; aspect-ratio: 16/9; }
        #remote-video { width: 100%; height: 100%; border-radius: 24px; object-fit: cover; background: #111; }
        #local-video { width: 120px; height: 160px; position: absolute; bottom: 20px; right: 20px; border-radius: 12px; border: 2px solid var(--accent); object-fit: cover; }
        
        /* Анимации */
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header class="h-16 flex items-center justify-between px-4 border-b border-white/5 bg-black/40 backdrop-blur-md z-10">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center font-bold text-white">H</div>
            <div>
                <h1 class="text-sm font-bold tracking-tight">HEXA <span class="text-blue-500">P2P</span></h1>
                <p id="status-text" class="text-[10px] text-zinc-500 uppercase tracking-widest">Connecting...</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <input type="text" id="targetId" class="bg-zinc-900 border border-white/5 rounded-lg px-3 py-1.5 text-xs outline-none focus:border-blue-500 w-24 md:w-40 transition-all" placeholder="ID друга">
            <button onclick="connectAndCall()" class="p-2 text-blue-500 hover:bg-blue-500/10 rounded-full transition"><i class="fas fa-video"></i></button>
        </div>
    </header>

    <main id="chat" class="flex-1 flex flex-col p-4 gap-1 overflow-y-auto bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')]">
        <div class="mx-auto my-4 px-4 py-1 bg-white/5 rounded-full text-[10px] text-zinc-500 uppercase">Сегодня</div>
    </main>

    <div id="callOverlay" class="call-overlay">
        <div class="video-box">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay muted playsinline></video>
        </div>
        <div class="mt-8 flex gap-6">
            <button onclick="hangUp()" class="w-16 h-16 bg-red-500 rounded-full flex items-center justify-center text-white text-2xl shadow-xl shadow-red-500/20"><i class="fas fa-phone-slash"></i></button>
        </div>
    </div>

    <footer class="p-3 md:p-4 bg-zinc-900/50 backdrop-blur-xl border-t border-white/5">
        <div class="max-w-4xl mx-auto flex items-end gap-2">
            <div class="flex-1 bg-zinc-800/50 rounded-2xl flex items-end p-2 border border-white/5">
                <textarea id="msgInput" rows="1" class="flex-1 bg-transparent border-none outline-none px-2 py-1 text-sm resize-none max-h-32" placeholder="Сообщение..."></textarea>
                <button onclick="sendMsg()" class="p-2 text-blue-500 hover:text-blue-400"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </footer>

    <script>
        const peer = new Peer();
        let conn, currentCall;

        peer.on('open', (id) => {
            document.getElementById('status-text').innerText = "Ваш ID: " + id;
            console.log('My ID:', id);
        });

        // Входящие
        peer.on('connection', c => { conn = c; setupConn(); });
        peer.on('call', async call => {
            if(confirm("Входящий звонок HEXA. Ответить?")) {
                const s = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
                document.getElementById('callOverlay').style.display = 'flex';
                document.getElementById('local-video').srcObject = s;
                call.answer(s);
                handleCall(call);
            }
        });

        function connectAndCall() {
            const id = document.getElementById('targetId').value;
            if(!id) return;
            conn = peer.connect(id);
            setupConn();
            startVideo(id);
        }

        async function startVideo(id) {
            const s = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
            document.getElementById('callOverlay').style.display = 'flex';
            document.getElementById('local-video').srcObject = s;
            handleCall(peer.call(id, s));
        }

        function setupConn() {
            conn.on('data', data => addBubble(data, 'peer'));
            addBubble("Собеседник в сети", "sys");
        }

        function sendMsg() {
            const input = document.getElementById('msgInput');
            if(!input.value.trim() || !conn) return;
            conn.send(input.value);
            addBubble(input.value, 'me');
            input.value = "";
        }

        function addBubble(text, type) {
            const chat = document.getElementById('chat');
            const div = document.createElement('div');
            if(type === 'sys') {
                div.className = "mx-auto text-[10px] text-zinc-600 uppercase my-2";
                div.innerText = text;
            } else {
                div.className = `bubble fade-in ${type === 'me' ? 'my-msg' : 'peer-msg'}`;
                div.innerText = text;
            }
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function handleCall(call) {
            currentCall = call;
            call.on('stream', s => document.getElementById('remote-video').srcObject = s);
        }

        function hangUp() {
            document.getElementById('callOverlay').style.display = 'none';
            if(currentCall) currentCall.close();
            const s = document.getElementById('local-video').srcObject;
            if(s) s.getTracks().forEach(t => t.stop());
        }

        // Авто-высота текста
        const tx = document.getElementById('msgInput');
        tx.addEventListener("input", function() {
            this.style.height = "auto";
            this.style.height = (this.scrollHeight) + "px";
        });
        tx.addEventListener('keypress', e => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); } });
    </script>
</body>
</html>
