<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HEXA | Secure P2P</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #09090b; color: #fafafa; font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; }
        .glass { background: rgba(24, 24, 27, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        #chat-area::-webkit-scrollbar { width: 4px; }
        #chat-area::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }
        .msg { max-width: 80%; padding: 10px 14px; border-radius: 18px; font-size: 14px; margin-bottom: 5px; animation: slideUp 0.2s ease-out; }
        .my { background: #2563eb; align-self: flex-end; border-bottom-right-radius: 4px; }
        .other { background: #27272a; align-self: flex-start; border-bottom-left-radius: 4px; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="loginScreen" class="fixed inset-0 z-[100] bg-zinc-950 flex items-center justify-center p-6">
        <div class="glass p-8 rounded-3xl w-full max-w-md shadow-2xl">
            <div class="w-16 h-16 bg-blue-600 rounded-2xl mb-6 mx-auto flex items-center justify-center text-3xl font-bold">H</div>
            <h2 class="text-2xl font-bold text-center mb-2">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
            <p class="text-zinc-500 text-center text-sm mb-8">–ü—Ä–∏–¥—É–º–∞–π—Ç–µ —Å–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –≤—Ö–æ–¥–∞</p>
            <input type="text" id="myIdInput" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl p-4 mb-4 outline-none focus:ring-2 ring-blue-600 transition" placeholder="–í–∞—à –Ω–∏–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä 1234)">
            <button onclick="initPeer()" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-bold transition">–í–û–ô–¢–ò –í –°–ò–°–¢–ï–ú–£</button>
        </div>
    </div>

    <div id="mainApp" class="hidden h-full flex flex-col">
        <header class="h-16 border-b border-white/5 flex items-center justify-between px-6 glass">
            <div class="flex items-center gap-3">
                <div id="onlineStatus" class="w-2 h-2 bg-green-500 rounded-full"></div>
                <span id="displayMyId" class="text-sm font-bold opacity-70"></span>
            </div>
            <div class="flex gap-2">
                <input type="text" id="targetId" class="bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-1 text-xs outline-none" placeholder="ID –¥—Ä—É–≥–∞">
                <button onclick="requestConnection()" class="bg-zinc-800 p-2 rounded-lg text-blue-400 hover:bg-zinc-700 transition"><i class="fas fa-plus"></i></button>
            </div>
        </header>

        <main id="chat-area" class="flex-1 overflow-y-auto p-6 flex flex-col gap-2">
            </main>

        <footer class="p-4 glass">
            <div class="max-w-4xl mx-auto flex gap-3">
                <input type="text" id="msgInput" class="flex-1 bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 outline-none focus:border-blue-500" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                <button onclick="send()" class="bg-blue-600 px-6 rounded-xl font-bold"><i class="fas fa-paper-plane"></i></button>
            </div>
        </footer>
    </div>

    <div id="requestModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-[200] p-6 backdrop-blur-sm">
        <div class="glass p-6 rounded-3xl w-full max-w-sm text-center">
            <div class="text-4xl mb-4">üëã</div>
            <h3 id="requestText" class="text-lg font-bold mb-6"></h3>
            <div class="flex gap-3">
                <button onclick="rejectRequest()" class="flex-1 bg-zinc-800 py-3 rounded-xl font-bold hover:bg-zinc-700 transition">–û–¢–ö–õ–û–ù–ò–¢–¨</button>
                <button onclick="acceptRequest()" class="flex-1 bg-blue-600 py-3 rounded-xl font-bold hover:bg-blue-500 transition">–ü–†–ò–ù–Ø–¢–¨</button>
            </div>
        </div>
    </div>

    <script>
        let peer, conn;
        let pendingConn = null;
        let blockedPeers = new Set();
        let acceptedPeers = new Set();

        function initPeer() {
            const myId = document.getElementById('myIdInput').value.trim();
            if (!myId) return alert("–í–≤–µ–¥–∏—Ç–µ ID");

            peer = new Peer(myId);

            peer.on('open', (id) => {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'flex';
                document.getElementById('displayMyId').innerText = "–í–´: " + id;
            });

            peer.on('error', (err) => {
                if(err.type === 'unavailable-id') alert("–≠—Ç–æ—Ç ID —É–∂–µ –∑–∞–Ω—è—Ç. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π.");
                else alert("–û—à–∏–±–∫–∞: " + err.type);
            });

            // –í—Ö–æ–¥—è—â–µ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
            peer.on('connection', (c) => {
                if (blockedPeers.has(c.peer)) {
                    c.close();
                    return;
                }
                
                if (!acceptedPeers.has(c.peer)) {
                    pendingConn = c;
                    showRequest(c.peer);
                } else {
                    conn = c;
                    setupConn();
                }
            });
        }

        function showRequest(id) {
            document.getElementById('requestText').innerText = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${id} —Ö–æ—á–µ—Ç –Ω–∞—á–∞—Ç—å —á–∞—Ç —Å –≤–∞–º–∏`;
            document.getElementById('requestModal').style.display = 'flex';
        }

        function acceptRequest() {
            acceptedPeers.add(pendingConn.peer);
            conn = pendingConn;
            document.getElementById('requestModal').style.display = 'none';
            setupConn();
            addMsg(`–í—ã –ø—Ä–∏–Ω—è–ª–∏ –∑–∞–ø—Ä–æ—Å –æ—Ç ${conn.peer}`, 'sys');
            conn.send("[SYSTEM]: –ó–∞–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç. –¢–µ–ø–µ—Ä—å –º—ã –º–æ–∂–µ–º –æ–±—â–∞—Ç—å—Å—è.");
        }

        function rejectRequest() {
            blockedPeers.add(pendingConn.peer);
            pendingConn.send("[SYSTEM]: –ó–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω–µ–Ω.");
            pendingConn.close();
            document.getElementById('requestModal').style.display = 'none';
            pendingConn = null;
        }

        function requestConnection() {
            const targetId = document.getElementById('targetId').value.trim();
            if (!targetId) return;
            
            addMsg(`–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ ${targetId}...`, 'sys');
            conn = peer.connect(targetId);
            setupConn();
        }

        function setupConn() {
            conn.on('data', (data) => {
                if (data.includes("[SYSTEM]: –ó–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω–µ–Ω")) {
                    addMsg("–í–∞—à –∑–∞–ø—Ä–æ—Å –±—ã–ª –æ—Ç–∫–ª–æ–Ω–µ–Ω.", 'sys');
                    conn.close();
                } else if (data.includes("[SYSTEM]: –ó–∞–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç")) {
                    addMsg("–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø—Ä–∏–Ω—è–ª –≤–∞—à –∑–∞–ø—Ä–æ—Å!", 'sys');
                    acceptedPeers.add(conn.peer);
                } else {
                    addMsg(data, 'other');
                }
            });
        }

        function send() {
            const input = document.getElementById('msgInput');
            if (!input.value || !conn) return;
            
            if (!acceptedPeers.has(conn.peer)) {
                addMsg("–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –ø–∏—Å–∞—Ç—å, –ø–æ–∫–∞ –∑–∞–ø—Ä–æ—Å –Ω–µ –ø—Ä–∏–Ω—è—Ç.", "sys");
                return;
            }

            conn.send(input.value);
            addMsg(input.value, 'my');
            input.value = "";
        }

        function addMsg(text, type) {
            const chat = document.getElementById('chat-area');
            const div = document.createElement('div');
            if (type === 'sys') {
                div.className = "text-center text-[10px] text-zinc-600 uppercase my-2 tracking-widest";
            } else {
                div.className = `msg ${type === 'my' ? 'my' : 'other'}`;
            }
            div.innerText = text;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        document.getElementById('msgInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') send(); });
    </script>
</body>
</html>
